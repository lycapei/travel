<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="robots" content="noindex">
    
    <!-- iOS Web App 設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KANSAI 2026">

    <title>KANSAI 2026</title>
    
    <!-- Favicon 設定 -->
    <link rel="apple-touch-icon" href="image/favicon-2026-kansai.png">
    <link rel="icon" type="image/png" href="image/favicon-2026-kansai.png">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        :root {
            /* 日式極簡配色 */
            --primary: #546E7A;        
            --primary-light: #819CA9;
            --accent: #D4A373;        
            --bg: #F5F5F7;            
            --card-bg: #FFFFFF;
            --text-main: #2C3E50;
            --text-sub: #7F8C8D;
            --danger: #E74C3C;
            --success: #27AE60;
            
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius: 16px;
            --bottom-nav-height: 80px; /* 預估高度，用於計算 body padding */
            --header-base-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Noto Sans TC", sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            /* 增加底部空間，確保內容不被加高的導航列遮擋 (120px 足夠容納各種機型) */
            padding-bottom: 120px;
            line-height: 1.5;
        }

        /* ----------------
           Hero & Header
           ---------------- */
        .hero {
            position: relative;
            height: 380px;
            width: 100%;
            background-color: var(--primary);
            background-image: url('https://raw.githubusercontent.com/lycapei/travel/49b0899d56157d7b0816cee3d5e44d2b50d176b5/image/kansai_home_4x3.png');
            background-size: cover;
            background-position: center; 
        }
        .hero::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0) 60%, rgba(245,245,247,1) 100%);
        }

        /* Header 適配 iPhone 瀏海/動態島 */
        .header {
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            /* 高度 = 基本高度 + 頂部安全區域 */
            height: calc(var(--header-base-height) + env(safe-area-inset-top));
            /* 內距增加頂部安全區域，讓內容往下移，避開瀏海 */
            padding: env(safe-area-inset-top) 20px 0 20px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            z-index: 1000; 
            transition: all 0.3s ease; 
            background: transparent; 
            color: white;
        }
        .header-title { font-size: 1.2rem; font-weight: 800; letter-spacing: 1px; text-shadow: 0 2px 8px rgba(0,0,0,0.6); font-family: 'Futura', sans-serif; }
        
        .header.scrolled { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); color: var(--primary); box-shadow: 0 1px 10px rgba(0,0,0,0.1); }
        .header.scrolled .header-title { text-shadow: none; }
        .header.scrolled .rate-badge { background: #F0F2F5; color: var(--primary); border: none; }

        .rate-badge {
            background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); color: white;
            padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; gap: 5px; transition: all 0.3s;
        }

        /* ----------------
           Layout
           ---------------- */
        .container { position: relative; z-index: 10; margin-top: -50px; padding: 0; max-width: 600px; margin-left: auto; margin-right: auto; }

        /* Day Nav 適配 Header 高度 */
        .day-nav-container {
            background: var(--bg); 
            position: sticky; 
            /* 黏住的位置 = Header 的高度 (含安全區域) */
            top: calc(var(--header-base-height) + env(safe-area-inset-top)); 
            z-index: 90;
            padding: 10px 0; margin-bottom: 10px;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.03);
        }
        .day-nav { display: flex; overflow-x: auto; padding: 0 16px; gap: 10px; -ms-overflow-style: none; scrollbar-width: none; }
        .day-nav::-webkit-scrollbar { display: none; }
        .day-tab {
            flex: 0 0 auto; 
            background: white; 
            padding: 8px 0;
            border-radius: 20px;
            font-size: 0.85rem; 
            color: var(--text-sub); 
            border: 1px solid #eee;
            cursor: pointer; 
            transition: all 0.2s; 
            text-align: center;
            width: 72px; 
            min-width: 72px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            white-space: nowrap;
            overflow: hidden;
        }
        .day-tab.active {
            background: var(--primary); color: white; border-color: var(--primary);
            font-weight: 600; box-shadow: 0 4px 8px rgba(84, 110, 122, 0.3);
            transform: translateY(-1px);
        }
        .day-tab small { display: block; font-size: 0.7rem; opacity: 0.8; margin-top: 2px; }

        /* ----------------
           Weather Cards
           ---------------- */
        a.weather-card {
            display: flex !important;
            text-decoration: none !important;
            color: white !important;
            background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
            border-radius: var(--radius);
            padding: 20px 24px;   
            margin: 0 16px 24px; 
            align-items: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            position: relative;
            z-index: 1;
        }
        a.weather-card:active { transform: scale(0.98); }
        a.weather-card.sunny { background: linear-gradient(135deg, #fce38a 0%, #f38181 100%); }
        /* 晴時多雲 (橘色調帶點藍灰，不如晴天刺眼) */
        a.weather-card.partly-cloudy { background: linear-gradient(135deg, #FFD194 0%, #70E1F5 100%); }
        a.weather-card.cloudy { background: linear-gradient(135deg, #93a5cf 0%, #e4efe9 100%); color: #333 !important; }
        a.weather-card.rain { background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%); }
        a.weather-card.snow { background: linear-gradient(135deg, #83a4d4 0%, #b6fbff 100%); color: #2C3E50 !important; }

        .weather-icon-box { font-size: 2.2rem; margin-right: 16px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); width: 40px; text-align: center; }
        .weather-temp-box { font-size: 2rem; font-weight: 700; line-height: 1; margin-right: auto; }
        .weather-metrics-box { display: flex; align-items: center; gap: 16px; font-size: 0.95rem; font-weight: 500; margin-right: 12px; }
        .metric-item { display: flex; align-items: center; gap: 6px; white-space: nowrap; }
        .metric-item i { opacity: 0.8; font-size: 0.9rem; }
        .weather-arrow { opacity: 0.6; font-size: 1rem; }

        /* ----------------
           Route Map (Timeline Style)
           ---------------- */
        .route-map-container {
            padding: 0 16px 20px;
            overflow-x: auto;
            display: flex;
            gap: 0;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .route-map-container::-webkit-scrollbar { display: none; }

        .route-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 85px;
            position: relative;
            flex-shrink: 0;
        }

        .route-circle {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            font-size: 0.8rem;
            font-weight: 700;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .route-label {
            font-size: 0.75rem;
            color: var(--text-main);
            text-align: center;
            line-height: 1.3;
            font-weight: 600;
            padding: 0 4px;
        }

        .route-line {
            position: absolute;
            top: 14px;
            left: 50%;
            width: 100%;
            height: 0;
            border-top: 2px dashed #ddd;
            z-index: 1;
        }

        .route-step:last-child .route-line {
            display: none;
        }

        /* ----------------
           Interactive Map (Leaflet)
           ---------------- */
        .leaflet-map-container {
            height: 300px;
            width: calc(100% - 32px);
            margin: 0 16px 24px 16px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            z-index: 5;
        }

        /* ----------------
           Timeline Layout
           ---------------- */
        .timeline-container { padding: 0 16px 20px; }
        .day-detail { display: none; }
        .day-detail.active { display: block; animation: fadeIn 0.3s ease; }
        
        .timeline-item { display: flex; align-items: stretch; margin-bottom: 24px; gap: 16px; }
        
        .timeline-marker { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 60px;
            flex-shrink: 0; 
            padding-top: 2px;
            position: relative; 
        }
        
        /* 時間文字 */
        .timeline-time { 
            font-size: 0.9rem; 
            font-weight: 700; 
            color: var(--primary); 
            margin-bottom: 8px; 
            font-family: monospace, sans-serif; 
            letter-spacing: -0.5px;
            position: relative;
            z-index: 10; 
            background-color: var(--bg); 
            padding: 2px 0;
            width: 100%;
            text-align: center;
        }
        
        .timeline-visual { position: relative; flex-grow: 1; width: 100%; display: flex; justify-content: center; }
        
        /* 隱藏圓點 */
        .timeline-dot { display: none; }
        
        /* 線條 */
        .timeline-line { 
            position: absolute; 
            top: -10px;
            bottom: -36px; 
            width: 2px; 
            background: #E0E0E0; 
            z-index: 1; 
            left: 50%;
            transform: translateX(-50%);
        }
        .timeline-item:first-child .timeline-line { top: 0; }
        .timeline-item:last-child .timeline-line { display: none; }

        .content-col { flex-grow: 1; background: white; border-radius: var(--radius); box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
        
        /* Carousel Styles */
        .carousel-container {
            position: relative;
            width: 100%;
            height: 180px; /* Consistent height */
            overflow: hidden;
            background-color: #eee;
        }
        .carousel-track {
            display: flex;
            height: 100%;
            transition: transform 0.3s ease-out;
            cursor: pointer;
        }
        .carousel-slide {
            min-width: 100%;
            height: 100%;
            box-sizing: border-box;
        }
        .carousel-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .carousel-dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
            z-index: 5;
            background: rgba(0,0,0,0.2);
            padding: 4px 8px;
            border-radius: 10px;
        }
        .carousel-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: background 0.2s;
        }
        .carousel-dot.active {
            background: white;
            transform: scale(1.2);
        }

        /* Legacy Image Style (for non-carousel items) */
        .spot-image { width: 100%; height: 160px; object-fit: cover; background-color: #eee; }

        .spot-body { padding: 16px; }
        .spot-title { margin: 0 0 8px 0; font-size: 1.15rem; color: var(--text-main); font-weight: 700; }
        .spot-desc { font-size: 0.95rem; color: var(--text-sub); margin-bottom: 12px; line-height: 1.6; }
        .tags-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        .mini-tag { font-size: 0.75rem; padding: 4px 10px; border-radius: 6px; background: #f0f0f0; color: #555; font-weight: 600; }
        .mini-tag.must-eat { background: #FFF3E0; color: #E67E22; border: 1px solid #FFE0B2; }
        .mini-tag.must-see { background: #E8F5E9; color: #27AE60; border: 1px solid #C8E6C9; }
        .mini-tag.warn { background: #FFEBEE; color: #C0392B; border: 1px solid #FFCDD2; }
        .mini-tag.buy { background: #E3F2FD; color: #1976D2; border: 1px solid #BBDEFB; }
        .mini-tag.success { background: #E8F5E9; color: #27AE60; border: 1px solid #C8E6C9; }

        /* Navigation Button Style */
        .spot-nav-btn { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            background: #E3F2FD; 
            color: var(--primary); 
            padding: 12px; 
            border-radius: 8px; 
            font-size: 0.9rem; 
            font-weight: 600; 
            text-decoration: none; 
            margin-top: 10px; 
            transition: background 0.2s; 
            flex: 1; 
        }
        .spot-nav-btn:active { background: #BBDEFB; }
        .spot-nav-btn i { margin-right: 6px; }

        .spot-nav-btn.pending { background: #F0F0F0; color: #555; cursor: pointer; }
        .spot-nav-btn.pending:active { background: #E0E0E0; }
        .spot-nav-btn.disabled { background: #EEEEEE; color: #999; cursor: default; pointer-events: none; }

        /* ----------------
           Layout Utils & Modals
           ---------------- */
        .tab-content { display: none; padding-top:10px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        #view-itinerary { padding: 0; }

        /* Generic Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.2s; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .calc-card { background: white; width: 85%; max-width: 320px; border-radius: 16px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.2s; }
        .modal-overlay.show .calc-card { transform: scale(1); }
        .calc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-weight: 700; color: var(--primary); }
        .close-btn { background: none; border: none; font-size: 1.2rem; color: #999; cursor: pointer; }
        .calc-input-group { margin-bottom: 15px; position: relative; }
        .calc-label { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-weight: 600; font-size: 0.9rem; }
        .calc-input { width: 100%; padding: 12px 12px 12px 50px; border: 2px solid #eee; border-radius: 10px; font-size: 1.2rem; text-align: right; outline: none; font-family: monospace; }
        .calc-input:focus { border-color: var(--primary); }
        .rate-info { text-align: center; font-size: 0.8rem; color: #aaa; margin-top: 10px; }

        /* Lightbox */
        .lightbox {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 3000; opacity: 0; transition: opacity 0.3s;
        }
        .lightbox.active { display: flex; opacity: 1; }
        .lightbox-content-wrapper {
            position: relative;
            width: 100%;
            height: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .lightbox img { max-width: 100%; max-height: 100%; object-fit: contain; transition: opacity 0.2s; }
        .lightbox-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; cursor: pointer; padding: 10px; z-index: 3001; }
        
        /* Lightbox Dots */
        .lightbox-dots {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            z-index: 3001;
            padding-bottom: 20px;
        }
        .lightbox-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transition: all 0.2s;
        }
        .lightbox-dot.active {
            background: white;
            transform: scale(1.3);
        }

        /* Checklist Styles (New) */
        .checklist-group { margin-bottom: 15px; }
        .checklist-title { font-size: 1rem; font-weight: 700; color: var(--primary); margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .checklist-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.95rem; color: var(--text-main); }
        .checklist-item input[type="checkbox"] { margin-right: 10px; width: 18px; height: 18px; accent-color: var(--primary); }
        .checklist-alert { background: #FFF3E0; color: #E67E22; padding: 10px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 20px; border: 1px solid #FFE0B2; display: flex; align-items: center; gap: 8px; }
        
        .info-section { background: white; border-radius: var(--radius); padding: 20px; margin: 0 16px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .info-header { font-weight: 700; font-size: 1.1rem; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #eee; color: var(--primary); }
        .info-list-item { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.95rem; }
        
        /* Bottom Nav Optimized */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            /* 移除固定高度，改用 padding 撐開 */
            height: auto; 
            background: rgba(255, 255, 255, 0.98); 
            border-top: 1px solid rgba(0,0,0,0.05); 
            display: flex; justify-content: space-around; 
            align-items: center; 
            z-index: 1000; 
            /* 上方留白 12px */
            padding-top: 12px;
            /* 下方留白：安全區域 + 16px 緩衝，讓手指好點擊，不會卡到 Home Bar */
            padding-bottom: calc(env(safe-area-inset-bottom) + 16px);
        }
        .nav-item { 
            flex: 1; text-align: center; color: #BDC3C7; font-size: 0.8rem; cursor: pointer; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; }
        .hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 130px; /* Increased from 90px to avoid overlapping with nav on newer iPhones */
            right: 20px;
            width: 44px;
            height: 44px;
            background: white;
            color: var(--primary);
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 900;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.3s;
        }
        .back-to-top.show {
            opacity: 1;
            pointer-events: auto;
        }
        .back-to-top:active {
            transform: scale(0.9);
            background: #f8f9fa;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="header" id="app-header">
        <div class="header-title">KANSAI 2026</div>
        <div class="rate-badge" onclick="toggleCalculator()" id="rate-badge">
            <i class="fas fa-coins"></i> <span id="rate-text">...</span>
        </div>
    </header>

    <!-- Hero -->
    <div class="hero"></div>

    <main class="container">
        <!-- Itinerary -->
        <div id="view-itinerary" class="tab-content active">
            
            <!-- Day Nav -->
            <div class="day-nav-container">
                <div class="day-nav">
                    <div class="day-tab active" onclick="switchDay('d1', this)">Day 1<small>2/8 出發</small></div>
                    <div class="day-tab" onclick="switchDay('d2', this)">Day 2<small>2/9 京都</small></div>
                    <div class="day-tab" onclick="switchDay('d3', this)">Day 3<small>2/10 琵琶湖</small></div>
                    <div class="day-tab" onclick="switchDay('d4', this)">Day 4<small>2/11 奈良</small></div>
                    <div class="day-tab" onclick="switchDay('d5', this)">Day 5<small>2/12 大阪</small></div>
                    <div class="day-tab" onclick="switchDay('d6', this)">Day 6<small>2/13 神戶</small></div>
                    <div class="day-tab" onclick="switchDay('d7', this)">Day 7<small>2/14 返程</small></div>
                </div>
            </div>

            <!-- Day 1 -->
            <div id="day-d1" class="day-detail active">
                <a href="#" target="_blank" class="weather-card" id="weather-d1">
                    <div class="weather-icon-box"><i class="fas fa-cloud-sun weather-icon"></i></div>
                    <div class="weather-temp-box">--°</div>
                    <div class="weather-metrics-box">
                        <div class="metric-item"><i class="fas fa-temperature-high"></i> <span class="val-feels">--°</span></div>
                        <div class="metric-item"><i class="fas fa-umbrella"></i> <span class="val-rain">--%</span></div>
                    </div>
                    <div class="weather-arrow"><i class="fas fa-chevron-right"></i></div>
                </a>

                <!-- Day 1 Route Map -->
                <div class="route-map-container">
                    <div class="route-step"><div class="route-circle">1</div><div class="route-label">桃園機場<br>11:30</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">2</div><div class="route-label">關西機場<br>16:55</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">3</div><div class="route-label">京都站<br>19:34</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">4</div><div class="route-label">進進堂<br>19:40</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">5</div><div class="route-label">飯店<br>20:00</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">6</div><div class="route-label">晚餐<br>20:30</div><div class="route-line"></div></div>
                </div>

                <div class="timeline-container">
                    <!-- 新增：集合時間 -->
                    <div class="timeline-item">
                        <div class="timeline-marker">
                            <div class="timeline-time">11:30</div>
                            <div class="timeline-visual">
                                <div class="timeline-dot"></div>
                                <div class="timeline-line" style="top: 0;"></div>
                            </div>
                        </div>
                        <div class="content-col">
                            <div class="spot-body">
                                <h3 class="spot-title">桃園機場第二航廈集合</h3>
                                <div class="spot-desc">
                                    請務必準時抵達，辦理登機手續與行李托運。<br>
                                    <div style="margin-top:12px; padding:12px 14px; background:#f8f9fa; border-radius:8px; font-size:0.9rem; line-height:2.4; letter-spacing:0.5px; color:#444;">
                                        <div style="border-bottom:1px dashed #e0e0e0;"><strong>訂位代號 DZXXZ2</strong> <span style="color:#777; font-size:0.85rem;">(新臻比芙鬆)</span></div>
                                        <div style="border-bottom:1px dashed #e0e0e0;"><strong>訂位代號 E2DW7H</strong> <span style="color:#777; font-size:0.85rem;">(冠佩軒)</span></div>
                                        <div><strong>訂位代號 E2NV2N</strong> <span style="color:#777; font-size:0.85rem;">(爸媽)</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">13:30</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <!-- 長榮圖片 (更新) -->
                            <img src="https://img.freepik.com/free-photo/airplane_74190-463.jpg?semt=ais_hybrid&w=740&q=80" class="spot-image" alt="EVA Air" onerror="this.src='https://placehold.co/800x400?text=EVA+Air'">
                            <div class="spot-body">
                                <h3 class="spot-title">長榮航空 BR130 | 桃園 -> 關西</h3>
                                <div class="tags-row"><span class="mini-tag">航班</span><span class="mini-tag">TPE T2 -> KIX T1</span></div>
                                <div class="spot-desc">
                                    準時起飛，預計飛行時間 2h 25m。<br>
                                    <div style="margin-top:8px; padding:8px 10px; background:#f5f5f5; border-radius:8px; font-size:0.85rem; line-height:1.6; color:#444;">
                                        <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                                            <i class="fas fa-utensils" style="color:var(--primary);"></i> <strong>餐點預訂</strong>
                                        </div>
                                        <div style="padding-left:22px;">
                                            • 軒仔：兒童餐<br>
                                            • 肉鬆：斷奶餐
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">16:55</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <!-- 機場圖片 (更新) -->
                            <img src="https://images.unsplash.com/photo-1589452271712-64b8a66c7b71?q=80&w=1471&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" class="spot-image" alt="KIX" onerror="this.src='https://placehold.co/800x400?text=KIX+Airport'">
                            <div class="spot-body">
                                <h3 class="spot-title">抵達關西機場 T1</h3>
                                <div class="tags-row"><span class="mini-tag warn">入境</span><span class="mini-tag">領取票券</span></div>
                                <div class="spot-desc">辦理入境手續、領取行李。</div>
                                <a href="https://www.vjw.digital.go.jp/" target="_blank" class="spot-nav-btn">
                                    <i class="fas fa-clipboard-check"></i> Visit Japan Web
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">18:15</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <!-- HARUKA 圖片 (更新) -->
                            <img src="https://www.jr-hellokittyharuka.jp/assets/images/ogp.jpg" class="spot-image" alt="HARUKA" onerror="this.src='https://placehold.co/800x400?text=HARUKA'">
                            <div class="spot-body">
                                <h3 class="spot-title">HARUKA | 關西機場 -> 京都車站</h3>
                                <div class="tags-row"><span class="mini-tag">交通</span><span class="mini-tag">往京都</span></div>
                                <div class="spot-desc">
                                    • 車程約 80 分鐘<br>
                                    • 6 歲以下孩童不需購票，但無座位
                                    <div style="margin-top:12px; padding:12px 14px; background:#f8f9fa; border-radius:8px; font-size:0.9rem; line-height:2.4; letter-spacing:0.5px; color:#444;">
                                        <div style="border-bottom:1px dashed #e0e0e0; display:flex; align-items:center;">
                                            <i class="fas fa-train" style="color:var(--primary); margin-right:8px; width:20px; text-align:center;"></i> 
                                            <strong>18:15 → 19:34</strong>
                                        </div>
                                        <div style="border-bottom:1px dashed #e0e0e0; display:flex; align-items:center;">
                                            <i class="fas fa-train" style="color:var(--primary); margin-right:8px; width:20px; text-align:center;"></i> 
                                            <strong>18:45 → 20:04</strong>
                                        </div>
                                        <div style="border-bottom:1px dashed #e0e0e0; display:flex; align-items:center;">
                                            <i class="fas fa-train" style="color:var(--primary); margin-right:8px; width:20px; text-align:center;"></i> 
                                            <strong>19:16 → 20:32</strong>
                                        </div>
                                        <div style="display:flex; align-items:center;">
                                            <i class="fas fa-train" style="color:var(--primary); margin-right:8px; width:20px; text-align:center;"></i> 
                                            <strong>19:45 → 21:03</strong>
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top:10px;">
                                    <a href="https://guest-ui.west-qr.com/#/packages/login/signUp" class="spot-nav-btn" target="_blank">
                                        <i class="fas fa-ticket-alt"></i> 電子車票
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 19:40 進進堂 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">19:40</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://images.unsplash.com/photo-1509440159596-0249088772ff?q=80&w=1000&auto=format&fit=crop" class="spot-image" alt="Shinshindo Bakery" onerror="this.src='https://placehold.co/800x400?text=Bakery'">
                            <div class="spot-body">
                                <h3 class="spot-title">進進堂 JR京都站前店</h3>
                                <div class="tags-row"><span class="mini-tag must-eat">麵包名店</span><span class="mini-tag">早餐預備</span></div>
                                <div class="spot-desc">
                                    創立於1913年的京都麵包老舖，傳承自巴黎的道地烘焙技術，空氣中總是瀰漫著剛出爐的迷人麥香。這間位於京都車站前的分店，是品嚐京都洋食底蘊的絕佳選擇。<br>
                                    <strong>必買推薦：</strong>層次分明的「可頌」、料多實在的「咖哩麵包」，以及口感帶勁的「明太子法國麵包」。
                                </div>
                                <a href="https://maps.google.com/?q=進進堂+JR京都站前店" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                            </div>
                        </div>
                    </div>

                    <!-- 20:00 飯店 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">20:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <!-- Carousel for Hotel -->
                            <div class="carousel-container" id="hotel-carousel">
                                <div class="carousel-track">
                                    <div class="carousel-slide"><img src="https://www.hotel-androoms.com/aks/assets/pc/img/room_st_p1.jpg" alt="Room 1"></div>
                                    <div class="carousel-slide"><img src="https://www.hotel-androoms.com/aks/assets/pc/img/room_st_p2.jpg" alt="Room 2"></div>
                                    <div class="carousel-slide"><img src="https://www.hotel-androoms.com/aks/assets/pc/img/figure_st_p1.jpg" alt="Figure"></div>
                                    <div class="carousel-slide"><img src="https://www.hotel-androoms.com/aks/assets/pc/img/sento_pc.jpg" alt="Sento"></div>
                                </div>
                                <div class="carousel-dots">
                                    <div class="carousel-dot active" data-index="0"></div>
                                    <div class="carousel-dot" data-index="1"></div>
                                    <div class="carousel-dot" data-index="2"></div>
                                    <div class="carousel-dot" data-index="3"></div>
                                </div>
                            </div>

                            <div class="spot-body">
                                <h3 class="spot-title">Check-in: 京都七條安住睦世酒店</h3>
                                <div class="tags-row"><span class="mini-tag">住宿</span><span class="mini-tag must-see">大浴場</span></div>
                                <div class="spot-desc">
                                    Hotel Androoms Kyoto Shichijo<br>
                                    • 京都站步行約 8-10 分鐘<br>
                                    • 飯店設有大浴場 (1F)<br>
                                    • 附近步行可至全家超商、唐吉訶德及Yodobashi 電器賣場
                                    <div style="margin-top:8px; padding:10px; background:#f5f5f5; border-radius:8px; font-size:0.85rem; color:#555; line-height: 1.6;">
                                        <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px; font-weight:600; color:var(--primary);">
                                            <i class="fas fa-bed"></i> 訂房資訊
                                        </div>
                                        <div style="padding-left:4px;">
                                            • 共預訂 3 間「標準雙床房」<br>
                                            • 每間可供 2 位成人和 1 位孩童入住<br>
                                            • 訂房不含早餐
                                        </div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                    <a href="https://maps.google.com/?q=Hotel+Androoms+Kyoto+Shichijo" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                                    <a href="https://www.hotel-androoms.com/aks/guestrooms/" class="spot-nav-btn" target="_blank"><i class="fas fa-hotel"></i> 官網</a>
                                    <a href="https://www.bigfang.tw/blog/post/androoms-kyoto-shichijo" class="spot-nav-btn" target="_blank"><i class="fas fa-comment-dots"></i> 評價</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 20:30 晚餐 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">20:30</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://lh3.googleusercontent.com/p/AF1QipO3T8RwtsZhoXICvKJLWKu-3ytKAoctYcs_Mlh5=w203-h287-k-no" class="spot-image" alt="Okonomiyaki" onerror="this.src='https://placehold.co/800x400?text=Okonomiyaki'">
                            <div class="spot-body">
                                <h3 class="spot-title">晚餐：京ちゃばな 南新町</h3>
                                <div class="tags-row"><span class="mini-tag must-eat">番茄御好燒</span><span class="mini-tag">鐵板燒</span></div>
                                <div class="spot-desc">
                                    這家店以創意大阪燒聞名，必點「番茄御好燒」，將新鮮番茄與傳統醬汁結合，口感清爽獨特。店內氛圍輕鬆，非常適合第一晚的聚餐。
                                </div>
                                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                    <a href="https://maps.app.goo.gl/wJq5qZ8z8z8z8z8z8" class="spot-nav-btn" onclick="window.open('https://maps.google.com/?q=京茶花+南新町', '_blank'); return false;"><i class="fas fa-location-dot"></i> 導航</a>
                                    <!-- 實驗功能按鈕 -->
                                    <button class="spot-nav-btn" onclick="toggleMenu()" style="background:#FFF3E0; color:#E67E22; border:1px solid #FFE0B2;">
                                        <i class="fas fa-book-open"></i> 點餐小幫手
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Day 2 -->
            <div id="day-d2" class="day-detail">
                <a href="#" target="_blank" class="weather-card" id="weather-d2">
                    <div class="weather-icon-box"><i class="fas fa-cloud-sun weather-icon"></i></div>
                    <div class="weather-temp-box">--°</div>
                    <div class="weather-metrics-box">
                        <div class="metric-item"><i class="fas fa-temperature-high"></i> <span class="val-feels">--°</span></div>
                        <div class="metric-item"><i class="fas fa-umbrella"></i> <span class="val-rain">--%</span></div>
                    </div>
                    <div class="weather-arrow"><i class="fas fa-chevron-right"></i></div>
                </a>

                <!-- Day 2 Route Map -->
                <div class="route-map-container">
                    <div class="route-step"><div class="route-circle">1</div><div class="route-label">飯店<br>08:20</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">2</div><div class="route-label">嵐山<br>09:00</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">3</div><div class="route-label">午餐<br>12:00</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">4</div><div class="route-label">鐵道<br>14:00</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">5</div><div class="route-label">晚餐<br>18:00</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">6</div><div class="route-label">飯店<br>19:30</div><div class="route-line"></div></div>
                </div>
                <!-- FIXED ID: d2-map -->
                <div id="d2-map" class="leaflet-map-container"></div>

                <div class="timeline-container">
                    
                    <!-- 09:00 嵐山小火車 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">09:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://plus.unsplash.com/premium_photo-1664302959152-c51a246c88be?q=80&w=1744&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" class="spot-image" alt="Arashiyama" onerror="this.src='https://placehold.co/800x400?text=Arashiyama'">
                            <div class="spot-body">
                                <h3 class="spot-title">嵐山散策</h3>
                                <div class="tags-row"><span class="mini-tag must-see">竹林小徑</span><span class="mini-tag">渡月橋</span></div>
                                <div class="spot-desc">
                                    嵐山是京都最具代表性的風景勝地，四季皆有不同風情。行程從搭乘復古的「嵯峨野觀光小火車」開始，沿著保津川峽谷行駛，在開放式車廂中感受山風與絕美溪谷景色。下車後，步行進入舉世聞名的「竹林小徑」，高聳入雲的翠綠竹林遮蔽天空，光影灑落下充滿神秘與禪意，是拍攝全家福的絕佳地點。接著參拜以求良緣聞名的「野宮神社」，保留著日本最古老的黑木鳥居。最後漫步至嵐山的地標「渡月橋」，欣賞桂川的潺潺流水與背後嵐山的壯麗景色，感受平安時代貴族鍾愛的度假氛圍。沿途商店街更有各式抹茶甜點與紀念品，值得細細品味。
                                </div>
                                <a href="https://maps.google.com/?q=Arashiyama+Bamboo+Grove" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                            </div>
                        </div>
                    </div>

                    <!-- 12:00 嵐山午餐 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">12:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://images.unsplash.com/photo-1558985250-27a406d64cb3?auto=format&fit=crop&w=800&q=80" class="spot-image" alt="Kyoto Lunch" onerror="this.src='https://placehold.co/800x400?text=Kyoto+Lunch'">
                            <div class="spot-body">
                                <h3 class="spot-title">嵐山午餐</h3>
                                <div class="tags-row"><span class="mini-tag must-eat">湯豆腐</span><span class="mini-tag">蕎麥麵</span></div>
                                <div class="spot-desc">
                                    嵐山的湯豆腐口感細緻滑順，是當地名物。我們會找一家有大桌位的湯豆腐或蕎麥麵餐廳，讓一家大小都能舒適地享用暖呼呼的京都午餐。
                                </div>
                                <a href="https://maps.google.com/?q=Arashiyama+Lunch" class="spot-nav-btn"><i class="fas fa-utensils"></i> 搜尋附近餐廳</a>
                            </div>
                        </div>
                    </div>

                    <!-- 13:30 移動 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">13:30</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <div class="spot-body">
                                <h3 class="spot-title">移動：嵐山 -> 梅小路</h3>
                                <div class="tags-row"><span class="mini-tag">JR</span><span class="mini-tag">約30分</span></div>
                                <div class="spot-desc">
                                    從 JR 嵯峨嵐山站搭車前往 JR 梅小路京都西站。車程舒適快速，出站後立刻就能抵達鐵道博物館，非常方便。
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 14:00 鐵道博物館 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">14:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://www.kyotorailwaymuseum.jp/en/assets/img/enjoy/discover/img-diorama.jpg" class="spot-image" alt="Railway" onerror="this.src='https://placehold.co/800x400?text=Kyoto+Railway+Museum'">
                            <div class="spot-body">
                                <h3 class="spot-title">京都鐵道博物館</h3>
                                <div class="tags-row"><span class="mini-tag must-see">室內</span><span class="mini-tag">扇形車庫</span></div>
                                <div class="spot-desc">
                                    日本最大級別的鐵道博物館，是鐵道迷與親子遊客的聖地。館內收藏了從蒸汽火車到新幹線共 53 輛具有歷史價值的真實車輛，包括初代 0 系新幹線與充滿回憶的寢台列車。這裡強調「觀賞、觸摸、體驗」，除了能近距離觀察車輛底盤結構，還有讓小朋友瘋狂的模擬駕駛體驗。戶外擁有現存最古老的「扇形車庫」，停放著氣勢磅礴的蒸汽火車頭，每日更有「SL 蒸汽號」可供搭乘，親身感受鳴笛聲與煤炭氣味。二樓設有巨大的鐵道模型場景（Diorama），精細重現了列車運行的模樣。頂樓的天空露台還能眺望行駛中的東海道新幹線與京都塔美景，即使下雨或天冷也能在舒適的室內度過充實的下午。
                                </div>
                                <a href="https://maps.google.com/?q=Kyoto+Railway+Museum" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                            </div>
                        </div>
                    </div>

                    <!-- 18:00 晚餐 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">18:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://images.unsplash.com/photo-1552611052-33e04de081de?auto=format&fit=crop&w=800&q=80" class="spot-image" alt="Dinner" onerror="this.src='https://placehold.co/800x400?text=Dinner'">
                            <div class="spot-body">
                                <h3 class="spot-title">晚餐：梅小路 / 京都車站</h3>
                                <div class="tags-row"><span class="mini-tag">方便</span></div>
                                <div class="spot-desc">
                                    在梅小路公園附近或回京都車站用餐。京都車站大樓內有拉麵小路、炸豬排等多樣選擇，交通也方便，吃飽後能快速回到飯店休息。
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 19:30 飯店 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">19:30</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <!-- Day 2 Hotel Carousel -->
                            <div class="carousel-container">
                                <div class="carousel-track">
                                    <div class="carousel-slide"><img src="https://www.hotel-androoms.com/aks/assets/pc/img/room_st_p1.jpg" alt="Room 1"></div>
                                    <div class="carousel-slide"><img src="https://www.hotel-androoms.com/aks/assets/pc/img/room_st_p2.jpg" alt="Room 2"></div>
                                    <div class="carousel-slide"><img src="https://www.hotel-androoms.com/aks/assets/pc/img/figure_st_p1.jpg" alt="Figure"></div>
                                    <div class="carousel-slide"><img src="https://www.hotel-androoms.com/aks/assets/pc/img/sento_pc.jpg" alt="Sento"></div>
                                </div>
                                <div class="carousel-dots">
                                    <div class="carousel-dot active" data-index="0"></div>
                                    <div class="carousel-dot" data-index="1"></div>
                                    <div class="carousel-dot" data-index="2"></div>
                                    <div class="carousel-dot" data-index="3"></div>
                                </div>
                            </div>

                            <div class="spot-body">
                                <h3 class="spot-title">住宿: 京都七條安住睦世酒店</h3>
                                <div class="tags-row"><span class="mini-tag">連泊</span><span class="mini-tag">大浴場</span></div>
                                <div class="spot-desc">
                                    Hotel Androoms Kyoto Shichijo<br>
                                    • 京都站步行約 8-10 分鐘。本日續住。<br>
                                    • 飯店設有大浴場 (1F)<br>
                                    • 附近步行可至全家超商、唐吉訶德及Yodobashi 電器賣場
                                    <div style="margin-top:8px; padding:10px; background:#f5f5f5; border-radius:8px; font-size:0.85rem; color:#555; line-height: 1.6;">
                                        <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px; font-weight:600; color:var(--primary);">
                                            <i class="fas fa-bed"></i> 訂房資訊
                                        </div>
                                        <div style="padding-left:4px;">
                                            • 共預訂 3 間「標準雙床房」<br>
                                            • 每間可供 2 位成人和 1 位孩童入住<br>
                                            • 訂房不含早餐
                                        </div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                    <a href="https://maps.google.com/?q=Hotel+Androoms+Kyoto+Shichijo" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                                    <a href="https://www.hotel-androoms.com/aks/guestrooms/" class="spot-nav-btn" target="_blank"><i class="fas fa-hotel"></i> 官網</a>
                                    <a href="https://www.bigfang.tw/blog/post/androoms-kyoto-shichijo" class="spot-nav-btn" target="_blank"><i class="fas fa-comment-dots"></i> 評價</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Day 3 -->
            <div id="day-d3" class="day-detail">
                <a href="#" target="_blank" class="weather-card" id="weather-d3">
                    <div class="weather-icon-box"><i class="fas fa-snowflake weather-icon"></i></div>
                    <div class="weather-temp-box">--°</div>
                    <div class="weather-metrics-box"><div class="metric-item"><i class="fas fa-temperature-high"></i> <span class="val-feels">--°</span></div><div class="metric-item"><i class="fas fa-umbrella"></i> <span class="val-rain">--%</span></div></div>
                    <div class="weather-arrow"><i class="fas fa-chevron-right"></i></div>
                </a>

                <!-- Day 3 Route Map (Timeline Style) -->
                <div class="route-map-container">
                    <div class="route-step"><div class="route-circle">1</div><div class="route-label">飯店<br>07:30</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">2</div><div class="route-label">租車<br>08:00</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">3</div><div class="route-label">河合神社<br>10:00</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">4</div><div class="route-label">糺之森<br>散步</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">5</div><div class="route-label">下鴨神社<br>參拜</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">6</div><div class="route-label">琵琶湖<br>12:00</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">7</div><div class="route-label">近江牛<br>午餐</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">8</div><div class="route-label">滑雪場<br>14:30</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">9</div><div class="route-label">返回<br>17:00</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">10</div><div class="route-label">飯店<br>18:00</div><div class="route-line"></div></div>
                </div>

                <!-- FIXED ID: d3-map -->
                <div id="d3-map" class="leaflet-map-container"></div>

                <div class="timeline-container">
                    
                    <!-- 08:00 領取租車 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">08:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?auto=format&fit=crop&w=800&q=80" class="spot-image" alt="Car Rental" onerror="this.src='https://placehold.co/800x400?text=Car+Rental'">
                            <div class="spot-body">
                                <h3 class="spot-title">領取租車 (TOYOTA Rent a Car)</h3>
                                <div class="tags-row"><span class="mini-tag warn">證件</span><span class="mini-tag">京都站新幹線口店</span></div>
                                <div class="spot-desc">
                                    前往租車公司辦理取車手續，準備開啟自在的親子自駕之旅。
                                    <div style="margin-top:8px; padding:10px; background:#f5f5f5; border-radius:8px; font-size:0.85rem; color:#555; line-height: 1.6;">
                                        <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px; font-weight:600; color:var(--primary);">
                                            <i class="fas fa-clipboard-list"></i> 預約詳情
                                        </div>
                                        <div style="padding-left:4px;">
                                            • 預約號碼：99922326300、99922330100<br>
                                            • 應備物品：台灣駕照正本、日文譯本、護照以及信用卡。<br>
                                            • <span style="color:var(--success); font-weight:600;"><i class="fas fa-check-circle"></i> 已使用信用卡線上付款</span>
                                        </div>
                                    </div>
                                </div>
                                <a href="https://maps.google.com/?q=Toyota+Rent+a+Car+Kyoto+Station+Shinkansen+Exit" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                            </div>
                        </div>
                    </div>

                    <!-- 09:00 全體上車 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">09:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?auto=format&fit=crop&w=800&q=80" class="spot-image" alt="Driving" onerror="this.src='https://placehold.co/800x400?text=Driving+Start'">
                            <div class="spot-body">
                                <h3 class="spot-title">移動：飯店 -> 河合神社</h3>
                                <div class="tags-row"><span class="mini-tag">車程20min</span><span class="mini-tag">右駕注意</span></div>
                                <div class="spot-desc">
                                    <strong>車程時間：約 20 分鐘。</strong><br>
                                    沿途欣賞京都早晨的街道風光，車內播放喜歡的音樂，享受與家人在車內的專屬時光。
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 10:00 河合神社 (Moved from Day 2) -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">10:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <div class="carousel-container">
                                <div class="carousel-track">
                                    <div class="carousel-slide"><img src="https://s.yimg.com/ny/api/res/1.2/6G4SAak7sZcpZWzPoltWmA--/YXBwaWQ9aGlnaGxhbmRlcjt3PTY0MDtoPTQyNg--/https://media.zenfs.com/zh-Hant-TW/homerun/tw-travel.yahookimo.com.tw/102cda4bda65f52043c217580f6300d5" alt="Kawai Ema"></div>
                                    <div class="carousel-slide"><img src="https://resources.matcha-jp.com/resize/720x2000/2018/11/05-65883.webp" alt="Beauty Water"></div>
                                </div>
                                <div class="carousel-dots">
                                    <div class="carousel-dot active" data-index="0"></div>
                                    <div class="carousel-dot" data-index="1"></div>
                                </div>
                            </div>
                            <div class="spot-body">
                                <h3 class="spot-title">河合神社</h3>
                                <div class="tags-row"><span class="mini-tag must-see">女性守護</span><span class="mini-tag must-buy">手鏡繪馬</span></div>
                                <div class="spot-desc">
                                    位於糺之森南側入口的河合神社，供奉著被譽為「日本第一美麗神」的玉依姬命，是所有愛美女性必訪的能量景點。這裡最著名的便是「手鏡繪馬」，形狀如同一把復古手鏡，參拜者可以用自己的化妝品在繪馬上畫出理想中的妝容與表情，祈求內外兼修的美麗。此外，神社內販售的「美人水」是由花梨提取製成，據說有養顏美容的功效，酸甜溫熱的口感在冬季飲用特別暖心。
                                </div>
                                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                    <a href="https://maps.google.com/?q=河合神社" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                                    <a href="https://006cf976-9eb8-46a8-a101-f5dd7125e577.filesusr.com/ugd/d1ef02_3e02616ef68841c58ec7df08df1876c5.pdf" class="spot-nav-btn" target="_blank"><i class="fas fa-map"></i> 地圖</a>
                                    <a href="https://mimigo.tw/kawai-shrine/" class="spot-nav-btn" target="_blank"><i class="fas fa-comment-dots"></i> 遊記</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tadasu no Mori (Moved from Day 2) -->
                    <div class="timeline-item">
                        <div class="timeline-marker">
                            <div class="timeline-time" style="opacity: 0;">00:00</div>
                            <div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div>
                        </div>
                        <div class="content-col">
                            <img src="https://pimg.1px.tw/lifepoem/1537152336-1137221427.jpg" class="spot-image" alt="Tadasu no Mori" onerror="this.src='https://placehold.co/800x400?text=Tadasu+no+Mori'">
                            <div class="spot-body">
                                <h3 class="spot-title">糺之森</h3>
                                <div class="tags-row"><span class="mini-tag">森林浴</span><span class="mini-tag">世界遺產</span></div>
                                <div class="spot-desc">
                                    連接河合神社與下鴨神社本殿的，是這片佔地廣闊的原始森林「糺之森」。這片森林從繩文時代生存至今，被視為神的居住地，也是京都唯一的原生林。漫步在參天古木與清澈小溪之間，空氣中充滿了清新的芬多精與神聖的靜謐感。這裡四季景色分明，更是洗滌心靈、過濾世俗塵埃的絕佳散步道，讓人在此放慢腳步，感受千年的歷史流動。
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shimogamo Shrine (Moved from Day 2) -->
                    <div class="timeline-item">
                        <div class="timeline-marker">
                            <div class="timeline-time" style="opacity: 0;">00:00</div>
                            <div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div>
                        </div>
                        <div class="content-col">
                            <div class="carousel-container">
                                <div class="carousel-track">
                                    <div class="carousel-slide"><img src="https://static.gltjp.com/glt/data/directory/12000/11952/20210813_004459_92ebfe25_w1920.webp" alt="Shimogamo Gate"></div>
                                    <div class="carousel-slide"><img src="https://g.udn.com.tw/upfiles/B_KO/kocj/PSN_PHOTO/677/f_28662677_1.jpg" alt="Shimogamo Shrine"></div>
                                </div>
                                <div class="carousel-dots">
                                    <div class="carousel-dot active" data-index="0"></div>
                                    <div class="carousel-dot" data-index="1"></div>
                                </div>
                            </div>
                            <div class="spot-body">
                                <h3 class="spot-title">下鴨神社 (賀茂御祖神社)</h3>
                                <div class="tags-row"><span class="mini-tag must-see">水籤</span><span class="mini-tag must-eat">申餅</span></div>
                                <div class="spot-desc">
                                    正式名稱為「賀茂御祖神社」的下鴨神社，是京都最古老的神社之一，也被列為世界文化遺產。朱紅色的樓門在鬱鬱蔥蔥的森林中顯得格外莊嚴。這裡主要祈求國泰民安、身體健康與厄運消除。參拜完本殿後，別忘了造訪境內的特色景點，感受古都傳承千年的信仰文化與神秘力量。<br>
                                    <div style="margin-top:8px; padding-left:4px; border-left: 3px solid #eee; font-size: 0.9rem;">
                                        <strong>• 相生社：</strong> 參拜神樹「連理之賢木」，祈求戀愛結緣、夫妻和睦與家庭圓滿。<br>
                                        <strong>• 御手洗池：</strong> 體驗著名的「水籤」，將籤放入池中才會浮現文字，判定吉凶。<br>
                                        <strong>• 茶屋さるや：</strong> 必吃名物「申餅」，象徵無病消災的豆沙色麻糬，口感Q彈。
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                    <a href="https://maps.google.com/?q=賀茂御祖神社(下鴨神社)" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                                    <a href="https://006cf976-9eb8-46a8-a101-f5dd7125e577.filesusr.com/ugd/d1ef02_3e02616ef68841c58ec7df08df1876c5.pdf" class="spot-nav-btn" target="_blank"><i class="fas fa-map"></i> 地圖</a>
                                    <a href="https://bobbyfun.tw/2024-01-10-2723/" class="spot-nav-btn" target="_blank"><i class="fas fa-comment-dots"></i> 遊記</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 12:00 移動：下鴨神社 -> 琵琶湖 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">12:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://images.unsplash.com/photo-1640940146271-eed77f5eeb38?q=80&w=1738&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" class="spot-image" alt="Lake Biwa Road" onerror="this.src='https://placehold.co/800x400?text=Move+to+Biwa'">
                            <div class="spot-body">
                                <h3 class="spot-title">移動：下鴨神社 -> 琵琶湖</h3>
                                <div class="tags-row"><span class="mini-tag">車程60min</span><span class="mini-tag">湖岸道路</span></div>
                                <div class="spot-desc">
                                    <strong>車程時間：約 60 分鐘。</strong><br>
                                    告別京都的古意，驅車前往日本最大的湖泊——琵琶湖。<br>
                                    沿途可見城市景觀逐漸轉為開闊的湖光山色，波光粼粼的湖面映入眼簾，讓人心曠神怡。這是滋賀縣的象徵，也是關西重要的水源地，準備迎接壯麗的自然美景。
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 13:00 近江牛料理 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">13:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://imgzh.tabiiro.travel/article.tabiiro.jp/articles/sections/1729668434-01.jpg?w=1600&h=1100&mode=crop" class="spot-image" alt="Omi Beef" onerror="this.src='https://placehold.co/800x400?text=Omi+Beef'">
                            <div class="spot-body">
                                <h3 class="spot-title">午餐：近江牛料理</h3>
                                <div class="tags-row"><span class="mini-tag must-eat">三大和牛</span><span class="mini-tag">入口即化</span></div>
                                <div class="spot-desc">
                                    來到滋賀縣，絕對不能錯過日本三大和牛之一的「近江牛」。其特色在於肉質細膩、脂肪甘甜且入口即化。午餐安排享用正宗的近江牛料理，無論是燒肉、壽喜燒或牛排，都能品嚐到頂級牛肉的鮮美油脂在口中散開的幸福感，為下午的滑雪行程補充滿滿體力。
                                </div>
                                <a href="https://maps.google.com/?q=Omi+Beef+Restaurant+Shiga" class="spot-nav-btn"><i class="fas fa-utensils"></i> 搜尋附近餐廳</a>
                            </div>
                        </div>
                    </div>

                    <!-- 14:30 琵琶湖山谷 (Updated Time) -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">14:30</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://rocky.tw/wp-content/uploads/20180519003928_67.jpg" class="spot-image" alt="Snow" onerror="this.src='https://placehold.co/800x400?text=Biwako+Valley'">
                            <div class="spot-body">
                                <h3 class="spot-title">琵琶湖山谷 Snow Land</h3>
                                <div class="tags-row"><span class="mini-tag warn">保暖</span><span class="mini-tag">雪景</span></div>
                                <div class="spot-desc">
                                    搭乘全日本速度最快的纜車攀升至標高 1100 公尺的山頂，眼前是琵琶湖的絕美全景與銀白雪世界。前往「Snow Land」戲雪區，這裡是專為親子打造的樂園，可以體驗雪盆滑雪、堆雪人或打雪仗。山上空氣清新冷冽，請務必戴好手套與毛帽，盡情享受在關西難得的粉雪體驗。
                                </div>
                                <a href="https://maps.google.com/?q=Biwako+Valley" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                            </div>
                        </div>
                    </div>

                    <!-- 17:00 移動：琵琶湖 -> 京都市區 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">17:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://images.unsplash.com/photo-1761052877083-7ccf3aec5503?q=80&w=1548&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" class="spot-image" alt="Sunset Drive" onerror="this.src='https://placehold.co/800x400?text=Drive+Back'">
                            <div class="spot-body">
                                <h3 class="spot-title">移動：琵琶湖 -> 京都市區</h3>
                                <div class="tags-row"><span class="mini-tag">夕陽</span><span class="mini-tag">休息</span></div>
                                <div class="spot-desc">
                                    <strong>車程時間：約 40-50 分鐘。</strong><br>
                                    結束了歡樂的雪上時光，搭乘纜車下山，準備驅車返回京都市區。傍晚時分，夕陽餘暉灑在琵琶湖面上，別有一番風味。回程時可以稍作休息，分享今日滑雪的有趣照片，或討論晚餐想吃什麼，帶著滿足的心情回到熟悉的京都。
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 18:00 飯店 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">18:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <!-- Day 3 Hotel Carousel (Updated) -->
                            <div class="carousel-container">
                                <div class="carousel-track">
                                    <div class="carousel-slide"><img src="https://www.hotel-androoms.com/aks/assets/pc/img/room_st_p1.jpg" alt="Room 1"></div>
                                    <div class="carousel-slide"><img src="https://www.hotel-androoms.com/aks/assets/pc/img/room_st_p2.jpg" alt="Room 2"></div>
                                    <div class="carousel-slide"><img src="https://www.hotel-androoms.com/aks/assets/pc/img/figure_st_p1.jpg" alt="Figure"></div>
                                    <div class="carousel-slide"><img src="https://www.hotel-androoms.com/aks/assets/pc/img/sento_pc.jpg" alt="Sento"></div>
                                </div>
                                <div class="carousel-dots">
                                    <div class="carousel-dot active" data-index="0"></div>
                                    <div class="carousel-dot" data-index="1"></div>
                                    <div class="carousel-dot" data-index="2"></div>
                                    <div class="carousel-dot" data-index="3"></div>
                                </div>
                            </div>

                            <div class="spot-body">
                                <h3 class="spot-title">住宿: 京都七條安住睦世酒店</h3>
                                <div class="tags-row"><span class="mini-tag">連泊</span><span class="mini-tag must-see">大浴場</span></div>
                                <div class="spot-desc">
                                    Hotel Androoms Kyoto Shichijo<br>
                                    • 京都站步行約 8-10 分鐘。本日續住。<br>
                                    • 飯店設有大浴場 (1F)<br>
                                    • 附近步行可至全家超商、唐吉訶德及Yodobashi 電器賣場
                                    <div style="margin-top:8px; padding:10px; background:#f5f5f5; border-radius:8px; font-size:0.85rem; color:#555; line-height: 1.6;">
                                        <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px; font-weight:600; color:var(--primary);">
                                            <i class="fas fa-bed"></i> 訂房資訊
                                        </div>
                                        <div style="padding-left:4px;">
                                            • 共預訂 3 間「標準雙床房」<br>
                                            • 每間可供 2 位成人和 1 位孩童入住<br>
                                            • 訂房不含早餐
                                        </div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                    <a href="https://maps.google.com/?q=Hotel+Androoms+Kyoto+Shichijo" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                                    <a href="https://www.hotel-androoms.com/aks/guestrooms/" class="spot-nav-btn" target="_blank"><i class="fas fa-hotel"></i> 官網</a>
                                    <a href="https://www.bigfang.tw/blog/post/androoms-kyoto-shichijo" class="spot-nav-btn" target="_blank"><i class="fas fa-comment-dots"></i> 評價</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <!-- Interactive Map Day 3 -->
                <div id="d3-map" class="leaflet-map-container"></div>
            </div>

            <!-- Day 4 -->
            <div id="day-d4" class="day-detail">
                <a href="#" target="_blank" class="weather-card" id="weather-d4">
                    <div class="weather-icon-box"><i class="fas fa-cloud-sun weather-icon"></i></div>
                    <div class="weather-temp-box">--°</div>
                    <div class="weather-metrics-box"><div class="metric-item"><i class="fas fa-temperature-high"></i> <span class="val-feels">--°</span></div><div class="metric-item"><i class="fas fa-umbrella"></i> <span class="val-rain">--%</span></div></div>
                    <div class="weather-arrow"><i class="fas fa-chevron-right"></i></div>
                </a>

                <!-- Day 4 Route Map & Interactive Map -->
                <div class="route-map-container">
                    <div class="route-step"><div class="route-circle">1</div><div class="route-label">飯店<br>09:00</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">2</div><div class="route-label">宇治<br>10:00</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">3</div><div class="route-label">奈良<br>13:30</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">4</div><div class="route-label">大阪<br>16:30</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">5</div><div class="route-label">飯店<br>18:00</div><div class="route-line"></div></div>
                </div>
                <!-- FIXED ID: d4-map -->
                <div id="d4-map" class="leaflet-map-container"></div>

                <div class="timeline-container">
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">10:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://images.unsplash.com/photo-1545569341-9eb8b30979d9?auto=format&fit=crop&w=800&q=80" class="spot-image" alt="Uji" onerror="this.src='https://placehold.co/800x400?text=Uji'">
                            <div class="spot-body">
                                <h3 class="spot-title">宇治</h3>
                                <div class="tags-row"><span class="mini-tag must-eat">抹茶</span><span class="mini-tag">平等院</span></div>
                                <div class="spot-desc">
                                    漫步於宇治川邊，參觀世界遺產「平等院」（10元硬幣圖案）。宇治是日本茶的故鄉，街道上瀰漫著茶香。<br><strong>必吃：</strong> 中村藤吉或伊藤久右衛門的抹茶甜點。
                                </div>
                                <a href="https://maps.google.com/?q=Uji+Bridge" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">13:30</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://img.cooljapan-videos.com/files/member_posts/image/c4da68612c32e98b658535a692d6c7a090309cc8.jpg" class="spot-image" alt="Nara" onerror="this.src='https://placehold.co/800x400?text=Nara+Deer'">
                            <div class="spot-body">
                                <h3 class="spot-title">奈良公園</h3>
                                <div class="tags-row"><span class="mini-tag warn">注意安全</span><span class="mini-tag must-see">東大寺</span></div>
                                <div class="spot-desc">
                                    與可愛的小鹿近距離接觸。參觀著名的東大寺與大佛。<br><strong>警告：</strong> 鹿群看到仙貝會非常熱情甚至包圍，請保護好小孩與手上的食物。
                                </div>
                                <a href="https://maps.google.com/?q=Nara+Park" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">16:30</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <div class="spot-body">
                                <h3 class="spot-title">前往大阪</h3>
                                <div class="tags-row"><span class="mini-tag">交通</span></div>
                                <div class="spot-desc">搭乘 JR 或近鐵電車移動至大阪市區。</div>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">18:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <!-- Carousel for Osaka Hotel -->
                            <div class="carousel-container">
                                <div class="carousel-track">
                                    <div class="carousel-slide"><img src="https://www.viewhotels.jp/osaka/wp-content/uploads/sites/12/2020/01/12-4-1240x860.jpg" alt="Exterior"></div>
                                    <div class="carousel-slide"><img src="https://photo.settour.com.tw/900x600/https://i.travelapi.com/lodging/24000000/23130000/23127700/23127660/f9a8ee70_z.jpg" alt="Room"></div>
                                </div>
                                <div class="carousel-dots">
                                    <div class="carousel-dot active" data-index="0"></div>
                                    <div class="carousel-dot" data-index="1"></div>
                                </div>
                            </div>

                            <div class="spot-body">
                                <h3 class="spot-title">Check-in: 大阪本町豪景飯店</h3>
                                <div class="tags-row"><span class="mini-tag">住宿</span><span class="mini-tag">本町站</span></div>
                                <div class="spot-desc">
                                    Osaka View Hotel Honmachi<br>
                                    位於本町站附近，交通便利。<br>
                                    <div style="margin-top:8px; padding:10px; background:#f5f5f5; border-radius:8px; font-size:0.85rem; color:#555; line-height: 1.6;">
                                        <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px; font-weight:600; color:var(--primary);">
                                            <i class="fas fa-bed"></i> 訂房資訊 (2晚)
                                        </div>
                                        <div style="padding-left:4px;">
                                            • 共預訂 2 間「標準雙床房」與 1 間「家庭間」<br>
                                            • 訂房不含早餐<br>
                                            • 付款狀態：已擔保，現場付款<br>
                                            • 取消政策：2/8 前免費取消
                                        </div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                    <a href="https://maps.google.com/?q=Osaka+View+Hotel+Honmachi" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                                    <a href="https://www.viewhotels.jp/osaka/zh-hant/rooms/standard/#standard-twin" class="spot-nav-btn" target="_blank"><i class="fas fa-hotel"></i> 官網</a>
                                    <a href="https://itravelblog.net/osaka-view-hotel-honmachi/" class="spot-nav-btn" target="_blank"><i class="fas fa-comment-dots"></i> 評價</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Day 5 -->
            <div id="day-d5" class="day-detail">
                 <a href="#" target="_blank" class="weather-card" id="weather-d5">
                    <div class="weather-icon-box"><i class="fas fa-sun weather-icon"></i></div>
                    <div class="weather-temp-box">--°</div>
                    <div class="weather-metrics-box"><div class="metric-item"><i class="fas fa-umbrella"></i> <span class="val-rain">--%</span></div><div class="metric-item"><i class="fas fa-temperature-high"></i> <span class="val-feels">--°</span></div></div>
                    <div class="weather-arrow"><i class="fas fa-chevron-right"></i></div>
                </a>

                <!-- Day 5 Route Map & Interactive Map -->
                <div class="route-map-container">
                    <div class="route-step"><div class="route-circle">1</div><div class="route-label">飯店<br>09:15</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">2</div><div class="route-label">海遊館<br>10:00</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">3</div><div class="route-label">樂高<br>13:00</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">4</div><div class="route-label">心齋橋<br>16:00</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">5</div><div class="route-label">飯店<br>20:00</div><div class="route-line"></div></div>
                </div>
                <!-- FIXED ID: d5-map -->
                <div id="d5-map" class="leaflet-map-container"></div>

                <div class="timeline-container">
                    <div class="timeline-item">
                         <div class="timeline-marker"><div class="timeline-time">10:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                         <div class="content-col">
                            <img src="https://pt-tour.tw/wp-content/uploads/2016/11/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7-2016-11-03-%E4%B8%8B%E5%8D%885.11.18.png" class="spot-image" alt="Osaka Aquarium" onerror="this.src='https://placehold.co/800x400?text=Osaka+Aquarium'">
                             <div class="spot-body">
                                 <h3 class="spot-title">海遊館</h3>
                                 <div class="tags-row"><span class="mini-tag must-see">鯨鯊</span><span class="mini-tag">室內</span></div>
                                 <div class="spot-desc">世界最大級別的水族館之一，必看巨大鯨鯊與環太平洋火山帶生態展示。參觀時間約 2.5 小時。</div>
                                 <a href="https://maps.google.com/?q=Osaka+Aquarium+Kaiyukan" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                             </div>
                          </div>
                    </div>
                    <div class="timeline-item">
                         <div class="timeline-marker"><div class="timeline-time">13:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                         <div class="content-col">
                            <img src="https://travelcontentsapp.com/wp-content/uploads/OSAKA_LEGOLAND-Discovery-Center-Osaka-Admission-Ticket-1.webp" class="spot-image" alt="Ferris Wheel" onerror="this.src='https://placehold.co/800x400?text=Tempozan'">
                             <div class="spot-body">
                                 <h3 class="spot-title">樂高中心 / 天保山購物中心</h3>
                                 <div class="tags-row"><span class="mini-tag">親子</span><span class="mini-tag">摩天輪</span></div>
                                 <div class="spot-desc">位於海遊館旁。有室內樂高樂園 (需預約) 與天保山大摩天輪。購物中心內有美食街可解決午餐。</div>
                                 <a href="https://maps.google.com/?q=Legoland+Discovery+Center+Osaka" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                             </div>
                          </div>
                    </div>
                    <div class="timeline-item">
                         <div class="timeline-marker"><div class="timeline-time">16:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                         <div class="content-col">
                            <img src="https://cdn.kinnso.ai/laravel/posts/20240808-japan/content/1722849646_Screenshot_2024-08-05_at_5.20.33%E2%80%AFPM.png" class="spot-image" alt="Dotonbori" onerror="this.src='https://placehold.co/800x400?text=Dotonbori'">
                             <div class="spot-body">
                                 <h3 class="spot-title">大阪市區 (心齋橋/道頓堀)</h3>
                                 <div class="tags-row"><span class="mini-tag buy">購物</span><span class="mini-tag must-see">跑跑人</span></div>
                                 <div class="spot-desc">大阪最熱鬧的區域。必拍固力果跑跑人看板。心齋橋商店街藥妝、服飾齊全。</div>
                                 <a href="https://maps.google.com/?q=Dotonbori" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                             </div>
                          </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">20:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <!-- Carousel for Osaka Hotel (Day 5 Updated) -->
                            <div class="carousel-container">
                                <div class="carousel-track">
                                    <div class="carousel-slide"><img src="https://www.viewhotels.jp/osaka/wp-content/uploads/sites/12/2020/01/12-4-1240x860.jpg" alt="Exterior"></div>
                                    <div class="carousel-slide"><img src="https://photo.settour.com.tw/900x600/https://i.travelapi.com/lodging/24000000/23130000/23127700/23127660/f9a8ee70_z.jpg" alt="Room"></div>
                                </div>
                                <div class="carousel-dots">
                                    <div class="carousel-dot active" data-index="0"></div>
                                    <div class="carousel-dot" data-index="1"></div>
                                </div>
                            </div>

                            <div class="spot-body">
                                <h3 class="spot-title">住宿: 大阪本町豪景飯店</h3>
                                <div class="tags-row"><span class="mini-tag">連泊</span></div>
                                <div class="spot-desc">
                                    Osaka View Hotel Honmachi。<br>
                                    <div style="margin-top:8px; padding:10px; background:#f5f5f5; border-radius:8px; font-size:0.85rem; color:#555; line-height: 1.6;">
                                        <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px; font-weight:600; color:var(--primary);">
                                            <i class="fas fa-bed"></i> 訂房資訊 (續住)
                                        </div>
                                        <div style="padding-left:4px;">
                                            • 共預訂 2 間「標準雙床房」與 1 間「家庭間」<br>
                                            • 訂房不含早餐<br>
                                            • 付款狀態：已擔保，現場付款<br>
                                            • 取消政策：2/8 前免費取消
                                        </div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                    <a href="https://maps.google.com/?q=Osaka+View+Hotel+Honmachi" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                                    <a href="https://www.viewhotels.jp/osaka/zh-hant/rooms/standard/#standard-twin" class="spot-nav-btn" target="_blank"><i class="fas fa-hotel"></i> 官網</a>
                                    <a href="https://itravelblog.net/osaka-view-hotel-honmachi/" class="spot-nav-btn" target="_blank"><i class="fas fa-comment-dots"></i> 評價</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

             <!-- Day 6 -->
             <div id="day-d6" class="day-detail">
                <a href="#" target="_blank" class="weather-card" id="weather-d6">
                    <div class="weather-icon-box"><i class="fas fa-smile-beam weather-icon"></i></div>
                    <div class="weather-temp-box">--°</div>
                    <div class="weather-metrics-box"><div class="metric-item"><i class="fas fa-umbrella"></i> <span class="val-rain">--%</span></div><div class="metric-item"><i class="fas fa-temperature-high"></i> <span class="val-feels">--°</span></div></div>
                    <div class="weather-arrow"><i class="fas fa-chevron-right"></i></div>
                </a>

                <!-- Day 6 Route Map & Interactive Map -->
                <div class="route-map-container">
                    <div class="route-step"><div class="route-circle">1</div><div class="route-label">飯店<br>09:30</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">2</div><div class="route-label">麵包超人<br>10:30</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">3</div><div class="route-label">動物王國<br>13:30</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">4</div><div class="route-label">Outlet<br>16:30</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">5</div><div class="route-label">機場飯店<br>19:00</div><div class="route-line"></div></div>
                </div>
                <!-- FIXED ID: d6-map -->
                <div id="d6-map" class="leaflet-map-container"></div>

                <div class="timeline-container">
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">10:30</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://tluxe-aws.hmgcdn.com/public/article/2017/atl_20190604151741_116.jpg" 
                                 class="spot-image" 
                                 alt="Anpanman"
                                 onerror="this.src='https://placehold.co/800x400?text=Anpanman+Museum'">
                            <div class="spot-body">
                                <h3 class="spot-title">神戶麵包超人博物館</h3>
                                <div class="tags-row"><span class="mini-tag must-buy">限定麵包</span><span class="mini-tag must-see">室內</span></div>
                                <div class="spot-desc">位於 Mosaic 廣場旁。博物館在二樓（需門票）。一樓商店街免費。<br><strong>必買：</strong> 果醬爺爺麵包工廠現烤造型麵包。</div>
                                <a href="https://maps.google.com/?q=Kobe+Anpanman+Children's+Museum" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                            </div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">13:30</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://storage.googleapis.com/stateless-ourtrails/2017/06/feature-azTravel-Japan-Kobe-zoo.jpg" class="spot-image" alt="Animal Kingdom" onerror="this.src='https://placehold.co/800x400?text=Animal+Kingdom'">
                            <div class="spot-body">
                                <h3 class="spot-title">神戶動物王國</h3>
                                <div class="tags-row"><span class="mini-tag">互動</span><span class="mini-tag">雨備</span></div>
                                <div class="spot-desc">全天候型主題園區，可以近距離接觸水豚、餵食鳥類，非常適合親子同遊。</div>
                                <a href="https://maps.google.com/?q=Kobe+Animal+Kingdom" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                            </div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">16:30</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://images.unsplash.com/photo-1560243563-062bfc001d68?auto=format&fit=crop&w=800&q=80" class="spot-image" alt="Rinku Outlet" onerror="this.src='https://placehold.co/800x400?text=Rinku+Outlet'">
                            <div class="spot-body">
                                <h3 class="spot-title">泉佐野 Outlet (Rinku Premium Outlets)</h3>
                                <div class="tags-row"><span class="mini-tag buy">購物</span><span class="mini-tag">機場旁</span></div>
                                <div class="spot-desc">關西最大級 Outlet，距離關西機場僅一站。適合回國前最後採買。</div>
                                <a href="https://maps.google.com/?q=Rinku+Premium+Outlets" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                            </div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">19:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <!-- Carousel for OMO Hotel -->
                            <div class="carousel-container">
                                <div class="carousel-track">
                                    <div class="carousel-slide"><img src="https://marukoblog.tw/wp-content/uploads/2025/05/omo%E9%97%9C%E8%A5%BF%E6%A9%9F%E5%A0%B4-_1.jpg" alt="OMO Exterior"></div>
                                    <div class="carousel-slide"><img src="https://img.vialife.tw/webp/202306/4-28.jpg.webp" alt="OMO Lobby"></div>
                                    <div class="carousel-slide"><img src="https://media.hoshinoresorts.com/image/authenticated/s--do77SUwc--/c_fill,g_auto,h_532,w_800/f_auto,q_auto/v1680527354/230310_omo_kansai_0707_gr86bd.jpg" alt="OMO Room"></div>
                                    <div class="carousel-slide"><img src="https://media.hoshinoresorts.com/image/authenticated/s--VQ32BUod--/c_fill,g_auto,h_532,w_800/f_auto,q_auto/v1673952514/221102_rinku_12_mvqvgd.jpg" alt="OMO View"></div>
                                </div>
                                <div class="carousel-dots">
                                    <div class="carousel-dot active" data-index="0"></div>
                                    <div class="carousel-dot" data-index="1"></div>
                                    <div class="carousel-dot" data-index="2"></div>
                                    <div class="carousel-dot" data-index="3"></div>
                                </div>
                            </div>

                            <div class="spot-body">
                                <h3 class="spot-title">Check-in: OMO 關西機場</h3>
                                <div class="tags-row"><span class="mini-tag">星野集團</span><span class="mini-tag">臨空城站</span></div>
                                <div class="spot-desc">
                                    OMO Kansai Airport by Hoshino Resorts<br>
                                    • 位於臨空城站旁，方便隔天前往機場<br>
                                    • 飯店設有大浴場<br>
                                    • 樓下有 LAWSON 超商<br>
                                    • 附近有臨空城 Outlet (泉佐野)
                                    <div style="margin-top:8px; padding:10px; background:#f5f5f5; border-radius:8px; font-size:0.85rem; color:#555; line-height: 1.6;">
                                        <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px; font-weight:600; color:var(--primary);">
                                            <i class="fas fa-bed"></i> 訂房資訊
                                        </div>
                                        <div style="padding-left:4px;">
                                            • 共預訂 2 間「雙床房」與 1 間「日式西式房間」<br>
                                            • 訂房不含早餐<br>
                                            • 付款狀態：已使用信用卡付款<br>
                                            • 取消政策：1/23 前免費取消
                                        </div>
                                    </div>
                                </div>
                                <a href="https://maps.google.com/?q=OMO+Kansai+Airport" class="spot-nav-btn"><i class="fas fa-location-dot"></i> 導航</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Day 7 -->
             <div id="day-d7" class="day-detail">
                 <a href="#" target="_blank" class="weather-card cloudy" id="weather-d7">
                    <div class="weather-icon-box"><i class="fas fa-plane weather-icon"></i></div>
                    <div class="weather-temp-box">--°</div>
                    <div class="weather-metrics-box"><div class="metric-item"><i class="fas fa-umbrella"></i> <span class="val-rain">--%</span></div><div class="metric-item"><i class="fas fa-temperature-high"></i> <span class="val-feels">--°</span></div></div>
                    <div class="weather-arrow"><i class="fas fa-chevron-right"></i></div>
                </a>

                <!-- Day 7 Route Map & Interactive Map -->
                <div class="route-map-container">
                    <div class="route-step"><div class="route-circle">1</div><div class="route-label">飯店<br>07:50</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">2</div><div class="route-label">接駁車<br>08:00</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">3</div><div class="route-label">機場<br>08:15</div><div class="route-line"></div></div>
                    <div class="route-step"><div class="route-circle">4</div><div class="route-label">起飛<br>10:55</div><div class="route-line"></div></div>
                </div>
                <!-- FIXED ID: d7-map -->
                <div id="d7-map" class="leaflet-map-container"></div>

                <div class="timeline-container">
                    
                    <!-- 08:00 接駁車 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">08:00</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <div class="spot-body">
                                <h3 class="spot-title">接駁車 | 飯店 -> 關西機場T1</h3>
                                <div class="tags-row"><span class="mini-tag">交通</span><span class="mini-tag warn">準時</span></div>
                                <div class="spot-desc">
                                    <div style="margin-top:8px; padding:10px; background:#f5f5f5; border-radius:8px; font-size:0.85rem; color:#555; line-height: 1.6;">
                                        <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px; font-weight:600; color:var(--primary);">
                                            <i class="fas fa-info-circle"></i> 預訂資訊
                                        </div>
                                        <div style="padding-left:4px;">
                                            • 預訂 10 人<br>
                                            • 請於 07:50 於飯店一樓集合
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 08:15 抵達機場 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">08:15</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                             <img src="https://images.unsplash.com/photo-1536098561742-ca998e48cbcc?auto=format&fit=crop&w=800&q=80" class="spot-image" alt="KIX" onerror="this.src='https://placehold.co/800x400?text=KIX+Airport'">
                            <div class="spot-body">
                                <h3 class="spot-title">抵達 KIX 機場</h3>
                                <div class="tags-row"><span class="mini-tag">出境</span><span class="mini-tag">伴手禮</span></div>
                                <div class="spot-desc">
                                    辦理登機手續，最後伴手禮採買。<br>
                                    <div style="margin-top:12px; padding:12px 14px; background:#f8f9fa; border-radius:8px; font-size:0.9rem; line-height:2.4; letter-spacing:0.5px; color:#444;">
                                        <div style="border-bottom:1px dashed #e0e0e0;"><strong>訂位代號 DZXXZ2</strong> <span style="color:#777; font-size:0.85rem;">(新臻比芙鬆)</span></div>
                                        <div style="border-bottom:1px dashed #e0e0e0;"><strong>訂位代號 E2DW7H</strong> <span style="color:#777; font-size:0.85rem;">(冠佩軒)</span></div>
                                        <div><strong>訂位代號 E2NV2N</strong> <span style="color:#777; font-size:0.85rem;">(爸媽)</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 10:55 長榮航空 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">10:55</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://img.freepik.com/free-photo/airplane_74190-463.jpg?semt=ais_hybrid&w=740&q=80" class="spot-image" alt="EVA Air" onerror="this.src='https://placehold.co/800x400?text=EVA+Air'">
                            <div class="spot-body">
                                <h3 class="spot-title">長榮航空 BR177 | 關西 -> 桃園</h3>
                                <div class="tags-row"><span class="mini-tag">航班</span><span class="mini-tag">KIX T1 -> TPE T2</span></div>
                                <div class="spot-desc">
                                    預計飛行時間 3h 15m。<br>
                                    <div style="margin-top:8px; padding:8px 10px; background:#f5f5f5; border-radius:8px; font-size:0.85rem; line-height:1.6; color:#444;">
                                        <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                                            <i class="fas fa-utensils" style="color:var(--primary);"></i> <strong>餐點預訂</strong>
                                        </div>
                                        <div style="padding-left:22px;">
                                            • 軒仔：兒童餐<br>
                                            • 肉鬆：斷奶餐
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 13:10 抵達桃園 -->
                    <div class="timeline-item">
                        <div class="timeline-marker"><div class="timeline-time">13:10</div><div class="timeline-visual"><div class="timeline-dot"></div><div class="timeline-line"></div></div></div>
                        <div class="content-col">
                            <img src="https://plus.unsplash.com/premium_photo-1661955975506-04d3812be312?q=80&w=1471&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" class="spot-image" alt="TPE Airport" onerror="this.src='https://placehold.co/800x400?text=TPE+Airport'">
                            <div class="spot-body">
                                <h3 class="spot-title">抵達桃園機場 T2</h3>
                                <div class="tags-row"><span class="mini-tag success">回家</span></div>
                                <div class="spot-desc">領取行李，平安返家。</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>

        <!-- Info -->
        <div id="view-info" class="tab-content">
            <div class="info-section">
                <div class="info-header"><i class="fas fa-plane"></i> 航班資訊</div>
                <div style="margin-bottom: 16px;">
                    <div style="color:var(--text-sub); font-size:0.85rem; margin-bottom:4px;">去程 (BR130)</div>
                    <div style="font-size:1.1rem; font-weight:600; color:var(--text-main);">13:30 TPE <i class="fas fa-arrow-right" style="font-size:0.8rem; margin:0 4px; color:#ccc;"></i> 16:55 KIX</div>
                </div>
                <div style="margin-bottom: 4px;">
                    <div style="color:var(--text-sub); font-size:0.85rem; margin-bottom:4px;">回程 (BR177)</div>
                    <div style="font-size:1.1rem; font-weight:600; color:var(--text-main);">10:55 KIX <i class="fas fa-arrow-right" style="font-size:0.8rem; margin:0 4px; color:#ccc;"></i> 13:10 TPE</div>
                </div>
            </div>

            <!-- 新增：住宿預訂詳情 -->
            <div class="info-section">
                <div class="info-header"><i class="fas fa-bed"></i> 住宿預訂詳情</div>
                
                <!-- 1. 京都飯店 -->
                <div style="margin-bottom: 24px;">
                    <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:6px;">
                        <div style="color:var(--primary); font-weight:700; font-size:1rem;">京都七條安住睦世酒店</div>
                        <span class="mini-tag">3晚</span>
                    </div>
                    <div style="font-size:0.85rem; color:#999; margin-bottom:8px;">
                        <i class="far fa-calendar-alt"></i> 2026/02/08 - 02/11
                    </div>
                    
                    <div style="background:#F8F9FA; border-radius:8px; padding:12px; font-size:0.9rem; line-height:1.6; border:1px solid #eee;">
                        <div style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px dashed #e0e0e0;">
                            <div style="color:var(--text-main); font-weight:600;">房型分配 (6大4小)</div>
                            <div style="color:var(--text-sub);">• 標準雙床房 (20 平方公尺) x3</div>
                        </div>
                        <div>
                            <div style="color:#333; font-size:0.85rem; display:flex; align-items:center; gap:6px; margin-bottom:2px;">
                                <i class="fas fa-exclamation-circle" style="color:#999;"></i> 2/7 前免費取消
                            </div>
                            <div style="color:var(--text-sub); font-size:0.85rem;">
                                (將於 2/4 信用卡扣款)
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. 大阪飯店 -->
                <div style="margin-bottom: 24px;">
                    <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:6px;">
                        <div style="color:var(--primary); font-weight:700; font-size:1rem;">大阪本町觀景飯店</div>
                        <span class="mini-tag">2晚</span>
                    </div>
                    <div style="font-size:0.85rem; color:#999; margin-bottom:8px;">
                        <i class="far fa-calendar-alt"></i> 2026/02/11 - 02/13
                    </div>
                    
                    <div style="background:#F8F9FA; border-radius:8px; padding:12px; font-size:0.9rem; line-height:1.6; border:1px solid #eee;">
                        <div style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px dashed #e0e0e0;">
                            <div style="color:var(--text-main); font-weight:600;">房型分配 (6大4小)</div>
                            <div style="color:var(--text-sub);">• 標準雙床房 (20 平方公尺) x2</div>
                            <div style="color:var(--text-sub);">• 家庭間 (24 平方公尺) x1</div>
                        </div>
                        <div>
                            <div style="color:#333; font-size:0.85rem; display:flex; align-items:center; gap:6px; margin-bottom:2px;">
                                <i class="fas fa-exclamation-circle" style="color:#999;"></i> 2/8 前免費取消
                            </div>
                            <div style="color:var(--text-sub); font-size:0.85rem;">
                                (已擔保，現場付款)
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. 機場飯店 -->
                <div style="margin-bottom: 10px;">
                    <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:6px;">
                        <div style="color:var(--primary); font-weight:700; font-size:1rem;">OMO 關西機場 by 星野集團</div>
                        <span class="mini-tag">1晚</span>
                    </div>
                    <div style="font-size:0.85rem; color:#999; margin-bottom:8px;">
                        <i class="far fa-calendar-alt"></i> 2026/02/13 - 02/14
                    </div>
                    
                    <div style="background:#F8F9FA; border-radius:8px; padding:12px; font-size:0.9rem; line-height:1.6; border:1px solid #eee;">
                        <div style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px dashed #e0e0e0;">
                            <div style="color:var(--text-main); font-weight:600;">房型分配 (6大4小)</div>
                            <div style="color:var(--text-sub);">• 雙床房 (20 平方公尺) x2</div>
                            <div style="color:var(--text-sub);">• 日式西式房間 (36 平方公尺) x1</div>
                        </div>
                        <div>
                            <div style="color:#333; font-size:0.85rem; display:flex; align-items:center; gap:6px; margin-bottom:2px;">
                                <i class="fas fa-exclamation-circle" style="color:#999;"></i> 1/23 前免費取消
                            </div>
                            <div style="color:var(--success); font-size:0.85rem; font-weight:600;">
                                <i class="fas fa-check-circle"></i> 已使用信用卡付款
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="info-section">
                <div class="info-header"><i class="fas fa-phone-volume"></i> 緊急聯絡</div>
                <div class="info-list-item"><span class="info-label">日本報警</span><span class="info-value">110</span></div>
                <div class="info-list-item"><span class="info-label">救護車</span><span class="info-value">119</span></div>
            </div>
        </div>

        <!-- Prep -->
        <div id="view-prep" class="tab-content">
            <div class="checklist-alert">
                <i class="fas fa-exclamation-triangle"></i>
                <div>此清單僅供參考，重新整理網頁後勾選狀態會消失。</div>
            </div>

            <div class="info-section">
                <div class="info-header"><i class="fas fa-suitcase"></i> 行李打包清單</div>
                
                <div class="checklist-group">
                    <div class="checklist-title">重要證件</div>
                    <div class="checklist-item"><input type="checkbox"> 護照 (有效期6個月以上)</div>
                    <div class="checklist-item"><input type="checkbox"> 台灣駕照 (自駕用)</div>
                    <div class="checklist-item"><input type="checkbox"> 日文譯本駕照 (自駕用)</div>
                    <div class="checklist-item"><input type="checkbox"> 信用卡 (海外回饋高)</div>
                    <div class="checklist-item"><input type="checkbox"> 日幣現金</div>
                    <div class="checklist-item"><input type="checkbox"> Visit Japan Web QR Code</div>
                </div>

                <div class="checklist-group">
                    <div class="checklist-title">電子產品</div>
                    <div class="checklist-item"><input type="checkbox"> 手機 & 充電線</div>
                    <div class="checklist-item"><input type="checkbox"> 行動電源</div>
                    <div class="checklist-item"><input type="checkbox"> 海外 sim 卡 或 漫遊申請</div>
                    <div class="checklist-item"><input type="checkbox"> 轉接頭 (日本雙孔扁插同台灣)</div>
                </div>

                <div class="checklist-group">
                    <div class="checklist-title">衣物 (2月冬季)</div>
                    <div class="checklist-item"><input type="checkbox"> 發熱衣 / 發熱褲</div>
                    <div class="checklist-item"><input type="checkbox"> 羽絨外套 / 防風大衣</div>
                    <div class="checklist-item"><input type="checkbox"> 毛帽 / 圍巾 / 手套</div>
                    <div class="checklist-item"><input type="checkbox"> 好走的鞋 (防水佳)</div>
                    <div class="checklist-item"><input type="checkbox"> 換洗衣物 (洋蔥式穿法)</div>
                </div>

                <div class="checklist-group">
                    <div class="checklist-title">個人用品 & 藥物</div>
                    <div class="checklist-item"><input type="checkbox"> 成人備用藥物</div>
                    <div class="checklist-item"><input type="checkbox"> 兒童備用藥物</div>
                    <div class="checklist-item"><input type="checkbox"> 盥洗用品 / 保養品</div>
                    <div class="checklist-item"><input type="checkbox"> 拖鞋</div>
                    <div class="checklist-item"><input type="checkbox"> 口罩</div>
                    <div class="checklist-item"><input type="checkbox"> 摺疊傘 (雨備)</div>
                    <div class="checklist-item"><input type="checkbox"> 塑膠袋 (裝髒衣物)</div>
                </div>

                <div class="checklist-group">
                    <div class="checklist-title">寶寶用品</div>
                    <div class="checklist-item"><input type="checkbox"> 奶瓶</div>
                    <div class="checklist-item"><input type="checkbox"> 奶粉</div>
                    <div class="checklist-item"><input type="checkbox"> 尿布</div>
                    <div class="checklist-item"><input type="checkbox"> 屁屁膏</div>
                    <div class="checklist-item"><input type="checkbox"> 嬰兒揹巾</div>
                    <div class="checklist-item"><input type="checkbox"> 奶瓶晾曬組</div>
                    <div class="checklist-item"><input type="checkbox"> 奶瓶刷</div>
                    <div class="checklist-item"><input type="checkbox"> 奶瓶清潔劑</div>
                    <div class="checklist-item"><input type="checkbox"> 溫度計</div>
                    <div class="checklist-item"><input type="checkbox"> 嬰兒洗髮沐浴組</div>
                    <div class="checklist-item"><input type="checkbox"> 濕紙巾</div>
                    <div class="checklist-item"><input type="checkbox"> 嬰兒推車 (含雨罩)</div>
                    <div class="checklist-item"><input type="checkbox"> 小被子</div>
                    <div class="checklist-item"><input type="checkbox"> 湯匙、叉子、碗</div>
                    <div class="checklist-item"><input type="checkbox"> 矽膠圍兜</div>
                    <div class="checklist-item"><input type="checkbox"> 食物剪</div>
                    <div class="checklist-item"><input type="checkbox"> 水壺</div>
                    <div class="checklist-item"><input type="checkbox"> 保溫罐</div>
                    <div class="checklist-item"><input type="checkbox"> 旅行用煮水壺</div>
                    <div class="checklist-item"><input type="checkbox"> 小孩零食</div>
                    <div class="checklist-item"><input type="checkbox"> 小孩玩具</div>
                </div>
            </div>

            <div class="info-section">
                <div class="info-header"><i class="fas fa-car"></i> 日本自駕注意事項</div>
                <div class="checklist-group">
                    <div class="checklist-title">行前必備文件</div>
                    <div class="checklist-item">• 台灣駕照正本 (不能過期)</div>
                    <div class="checklist-item">• 駕照日文譯本 (監理站申請)</div>
                    <div class="checklist-item">• 護照</div>
                    <div class="checklist-item">• 信用卡 (租車刷卡用)</div>
                </div>
                <div class="checklist-group">
                    <div class="checklist-title">交通規則重點</div>
                    <div class="checklist-item" style="color:#E74C3C; font-weight:bold;">• 靠左行駛 (右駕)</div>
                    <div class="checklist-item">• 右轉大彎，左轉小彎</div>
                    <div class="checklist-item">• 看到「止まれ」(倒三角) 務必完全停止</div>
                    <div class="checklist-item">• 行人優先，轉彎禮讓行人</div>
                    <div class="checklist-item">• 高速公路內側為超車道，非超車勿佔用</div>
                </div>
                <div class="checklist-group">
                    <div class="checklist-title">緊急應對</div>
                    <div class="checklist-item">• 發生事故：先打 110 報警，再打給租車公司</div>
                    <div class="checklist-item">• 有人受傷：打 119 叫救護車</div>
                    <div class="checklist-item">• 違規停車被罰：需自行前往警察局繳納罰款</div>
                </div>
            </div>
        </div>

    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('itinerary', this)"><i class="fas fa-map-marked-alt"></i><span>行程</span></div>
        <div class="nav-item" onclick="switchTab('info', this)"><i class="fas fa-info-circle"></i><span>資訊</span></div>
        <div class="nav-item" onclick="switchTab('prep', this)"><i class="fas fa-clipboard-list"></i><span>準備</span></div>
    </nav>

    <!-- Back to Top Button -->
    <button id="backToTop" class="back-to-top" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Rate Modal -->
    <div id="rate-modal" class="modal-overlay">
        <div class="calc-card">
            <div class="calc-header">
                <span><i class="fas fa-exchange-alt"></i> 即時換算</span>
                <button class="close-btn" onclick="toggleCalculator()"><i class="fas fa-times"></i></button>
            </div>
            <div class="calc-input-group">
                <span class="calc-label">JPY 日幣</span>
                <input type="number" id="input-jpy" class="calc-input" placeholder="0" oninput="calculate('jpy')">
            </div>
            <div class="calc-input-group">
                <span class="calc-label">TWD 台幣</span>
                <input type="number" id="input-twd" class="calc-input" placeholder="0" oninput="calculate('twd')">
            </div>
            <div class="rate-info">
                目前匯率: 1 JPY ≈ <span id="modal-rate">0.218</span> TWD
                <div style="margin-top:8px; font-size:0.75rem; color:#aaa; line-height: 1.5;">
                    更新時間: <span id="rate-time">--</span><br>
                    資料來源: <a href="https://www.google.com/finance/quote/JPY-TWD" target="_blank" style="color:#aaa; text-decoration: underline;">Google Finance</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu Modal (實驗功能) -->
    <div id="menu-modal" class="modal-overlay">
        <div class="calc-card" style="max-width: 350px;">
            <div class="calc-header" style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 10px;">
                <span><i class="fas fa-utensils"></i> 點餐小幫手</span>
                <button class="close-btn" onclick="toggleMenu()"><i class="fas fa-times"></i></button>
            </div>
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 15px; text-align: center;">
                點擊喇叭圖示 <i class="fas fa-volume-up"></i> 手機就會幫你唸出日文喔！
            </div>
            
            <div class="menu-list" style="max-height: 400px; overflow-y: auto;">
                <!-- 菜單項目 1 -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f5f5f5;">
                    <div>
                        <div style="font-weight: 700; color: var(--text-main); font-size: 1rem;">番茄御好燒</div>
                        <div style="font-size: 0.85rem; color: var(--text-sub);">トマトお好み焼き</div>
                    </div>
                    <button onclick="speakJapanese('トマトお好み焼き')" style="background: var(--primary); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>

                <!-- 菜單項目 2 -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f5f5f5;">
                    <div>
                        <div style="font-weight: 700; color: var(--text-main); font-size: 1rem;">酪梨炒麵</div>
                        <div style="font-size: 0.85rem; color: var(--text-sub);">アボカド焼きそば</div>
                    </div>
                    <button onclick="speakJapanese('アボカド焼きそば')" style="background: var(--primary); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>

                <!-- 菜單項目 3 -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f5f5f5;">
                    <div>
                        <div style="font-weight: 700; color: var(--text-main); font-size: 1rem;">豚平燒 (蛋包豬肉)</div>
                        <div style="font-size: 0.85rem; color: var(--text-sub);">とん平焼き</div>
                    </div>
                    <button onclick="speakJapanese('とん平焼き')" style="background: var(--primary); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>

                <!-- 菜單項目 4 -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f5f5f5;">
                    <div>
                        <div style="font-weight: 700; color: var(--text-main); font-size: 1rem;">生啤酒</div>
                        <div style="font-size: 0.85rem; color: var(--text-sub);">生ビール</div>
                    </div>
                    <button onclick="speakJapanese('生ビール')" style="background: var(--primary); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
                 <!-- 菜單項目 5 -->
                 <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f5f5f5;">
                    <div>
                        <div style="font-weight: 700; color: var(--text-main); font-size: 1rem;">可樂</div>
                        <div style="font-size: 0.85rem; color: var(--text-sub);">コーラ</div>
                    </div>
                    <button onclick="speakJapanese('コーラ')" style="background: var(--primary); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lightbox (Updated Structure) -->
    <div id="lightbox" class="lightbox">
        <div class="lightbox-close" onclick="closeLightbox()">&times;</div>
        
        <!-- Wrap image to detect swipe more easily -->
        <div class="lightbox-content-wrapper">
             <img id="lightbox-img" src="" alt="Full view">
        </div>
        
        <!-- Add dots container -->
        <div class="lightbox-dots" id="lightbox-dots"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // ==========================================
        // ★★★ 天氣手動設定區 (旅途中請改這裡) ★★★
        // ==========================================
        // code (代碼) 參考: 
        // 0=晴天, 1=晴時多雲, 2=多雲, 3=陰天
        // 61=下雨, 71=下雪
        const MANUAL_FORECAST = {
            'weather-d1': { code: 71, temp: -2, realFeel: -9, rain: 55 }, // Day 1 (2/8) 少量降雪
            'weather-d2': { code: 0,  temp: 7,  realFeel: 4,  rain: 3  }, // Day 2 (2/9) 晴天
            'weather-d3': { code: 1,  temp: 10, realFeel: 9,  rain: 25 }, // Day 3 (2/10) 晴時多雲 (更新)
            'weather-d4': { code: 61, temp: 10, realFeel: 11, rain: 80 }, // Day 4 (2/11) 雨天
            'weather-d5': { code: 0,  temp: 12, realFeel: 13, rain: 0  }, // Day 5 (2/12) 晴天
            'weather-d6': { code: 0,  temp: 13, realFeel: 14, rain: 1  }, // Day 6 (2/13) 晴天
            'weather-d7': { code: 0,  temp: 14, realFeel: 16, rain: 0  }  // Day 7 (2/14) 晴天
        };
        // ==========================================

        let currentRate = 0.218;
        
        // --- Map Data for All Days ---
        const mapInstances = {}; // Store map instances by id
        const tourData = {
            /* d1 Removed (no map for day 1) */
            'd2': [
                { lat: 34.98917, lng: 135.75710, title: "1. 飯店" },
                { lat: 35.0094, lng: 135.6668, title: "2. 嵐山" },
                { lat: 35.0116, lng: 135.6760, title: "3. 午餐" },
                { lat: 34.9863, lng: 135.7419, title: "4. 鐵道博物館" },
                { lat: 34.9858, lng: 135.7588, title: "5. 晚餐" },
                { lat: 34.98917, lng: 135.75710, title: "6. 飯店" }
            ],
            'd3': [
                { lat: 34.98917, lng: 135.75710, title: "1. 飯店" },
                { lat: 34.9837, lng: 135.7587, title: "2. 租車 (京都站)" },
                { lat: 35.0340, lng: 135.7690, title: "3. 河合神社" },
                { lat: 35.0392, lng: 135.7730, title: "4. 下鴨神社" },
                { lat: 35.0050, lng: 135.8670, title: "5. 琵琶湖/午餐" }, 
                { lat: 35.2132, lng: 135.9042, title: "6. 琵琶湖山谷" },
                { lat: 34.98917, lng: 135.75710, title: "7. 飯店" }
            ],
            'd4': [
                { lat: 34.98917, lng: 135.75710, title: "1. 飯店" },
                { lat: 34.8893, lng: 135.8077, title: "2. 宇治平等院" },
                { lat: 34.6850, lng: 135.8430, title: "3. 奈良公園" },
                { lat: 34.6823, lng: 135.5005, title: "4. 大阪飯店" }
            ],
            'd5': [
                { lat: 34.6823, lng: 135.5005, title: "1. 飯店" },
                { lat: 34.6545, lng: 135.4289, title: "2. 海遊館" },
                { lat: 34.6560, lng: 135.4310, title: "3. 樂高/摩天輪" },
                { lat: 34.6687, lng: 135.5013, title: "4. 心齋橋/道頓堀" },
                { lat: 34.6823, lng: 135.5005, title: "5. 飯店" }
            ],
            'd6': [
                { lat: 34.6823, lng: 135.5005, title: "1. 飯店" },
                { lat: 34.6806, lng: 135.1864, title: "2. 麵包超人館" },
                { lat: 34.6378, lng: 135.2236, title: "3. 神戶動物王國" },
                { lat: 34.4067, lng: 135.2952, title: "4. 泉佐野Outlet" },
                { lat: 34.4105, lng: 135.3005, title: "5. 機場飯店" }
            ],
            'd7': [
                { lat: 34.4105, lng: 135.3005, title: "1. 飯店" },
                { lat: 34.4320, lng: 135.2304, title: "2. 關西機場" }
            ]
        };

        window.addEventListener('scroll', () => {
            const header = document.getElementById('app-header');
            if (window.scrollY > 200) { header.classList.add('scrolled'); } else { header.classList.remove('scrolled'); }
            
            // Back to Top Button Logic
            const backToTopBtn = document.getElementById('backToTop');
            if (window.scrollY > 300) {
                backToTopBtn.classList.add('show');
            } else {
                backToTopBtn.classList.remove('show');
            }
        });

        function switchTab(viewId, navEl) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            navEl.classList.add('active');
            window.scrollTo(0,0);
        }

        function switchDay(dayId, tabEl) {
            document.querySelectorAll('.day-detail').forEach(el => el.classList.remove('active'));
            document.getElementById('day-' + dayId).classList.add('active');
            document.querySelectorAll('.day-tab').forEach(el => el.classList.remove('active'));
            tabEl.classList.add('active');
            tabEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });

            // Initialize Map for selected day
            setTimeout(() => {
                initDayMap(dayId);
            }, 300); // Slight delay for animation
        }

        function initDayMap(dayId) {
            // Check if data exists for this day
            if (!tourData[dayId]) return;

            const mapId = dayId + '-map';
            const mapContainer = document.getElementById(mapId);
            
            if (!mapContainer) return;

            // If map already initialized, just fix layout
            if (mapInstances[dayId]) {
                mapInstances[dayId].invalidateSize();
                return;
            }

            const locations = tourData[dayId];
            
            // Calculate center
            const centerLat = locations[0].lat;
            const centerLng = locations[0].lng;

            // Initialize map
            const map = L.map(mapId).setView([centerLat, centerLng], 10);
            mapInstances[dayId] = map;

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            // Add markers & lines
            const latlngs = [];
            locations.forEach((loc) => {
                const marker = L.marker([loc.lat, loc.lng]).addTo(map);
                marker.bindPopup(`<b>${loc.title}</b>`);
                latlngs.push([loc.lat, loc.lng]);
            });

            // Draw polyline
            const polyline = L.polyline(latlngs, {color: '#546E7A', weight: 3, opacity: 0.7, dashArray: '5, 10'}).addTo(map);

            // Fit bounds
            if (latlngs.length > 0) {
                map.fitBounds(polyline.getBounds(), { padding: [30, 30] });
            }
        }

        function toggleCalculator() {
            const modal = document.getElementById('rate-modal');
            if (modal.classList.contains('show')) {
                modal.classList.remove('show');
                setTimeout(() => { modal.style.display = 'none'; }, 200); 
            } else {
                modal.style.display = 'flex';
                setTimeout(() => { modal.classList.add('show'); }, 10);
                document.getElementById('input-jpy').value = '';
                document.getElementById('input-twd').value = '';
                document.getElementById('input-jpy').focus();
            }
        }

        document.getElementById('rate-modal').addEventListener('click', function(e) {
            if (e.target === this) toggleCalculator();
        });

        // Menu Modal Logic
        function toggleMenu() {
            const modal = document.getElementById('menu-modal');
            if (modal.classList.contains('show')) {
                modal.classList.remove('show');
                setTimeout(() => { modal.style.display = 'none'; }, 200); 
            } else {
                modal.style.display = 'flex';
                setTimeout(() => { modal.classList.add('show'); }, 10);
            }
        }

        document.getElementById('menu-modal').addEventListener('click', function(e) {
            if (e.target === this) toggleMenu();
        });

        function speakJapanese(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP'; // 設定為日文
                utterance.rate = 0.8; // 稍微放慢語速，方便模仿
                window.speechSynthesis.speak(utterance);
            } else {
                alert('您的瀏覽器不支援語音功能');
            }
        }

        function calculate(source) {
            const jpyInput = document.getElementById('input-jpy');
            const twdInput = document.getElementById('input-twd');
            if (source === 'jpy') {
                const jpy = parseFloat(jpyInput.value);
                if (!isNaN(jpy)) { twdInput.value = (jpy * currentRate).toFixed(0); } else { twdInput.value = ''; }
            } else {
                const twd = parseFloat(twdInput.value);
                if (!isNaN(twd)) { jpyInput.value = (twd / currentRate).toFixed(0); } else { jpyInput.value = ''; }
            }
        }

        async function fetchRate() {
            // Set Loading state
            document.getElementById('rate-text').innerText = '...';
            
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/JPY');
                const data = await response.json();
                if (data && data.rates && data.rates.TWD) {
                    currentRate = data.rates.TWD;
                    document.getElementById('rate-text').innerText = currentRate.toFixed(3);
                    document.getElementById('modal-rate').innerText = currentRate.toFixed(3);
                    
                    // Parse Time
                    if (data.time_last_update_unix) {
                        const date = new Date(data.time_last_update_unix * 1000);
                        const dateStr = date.toLocaleString('zh-TW', { hour12: false, month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' });
                        document.getElementById('rate-time').innerText = dateStr;
                    }
                } else {
                    throw new Error('No rate data');
                }
            } catch (e) { 
                console.log('Using default rate', e); 
                document.getElementById('rate-text').innerText = '(預設) ' + currentRate.toFixed(3);
                document.getElementById('rate-time').innerText = '無法取得 (使用離線預設值)';
            }
        }

        async function fetchWeather() {
            // 定義地點與「預設天氣」
            const locations = [
                { 
                    id: 'weather-d1', lat: 35.01, lon: 135.76, date: '2026-02-08', 
                    accuUrl: 'https://www.accuweather.com/zh/jp/kyoto-shi/224436/daily-weather-forecast/224436',
                },
                { 
                    id: 'weather-d2', lat: 35.01, lon: 135.76, date: '2026-02-09', 
                    accuUrl: 'https://www.accuweather.com/zh/jp/kyoto-shi/224436/daily-weather-forecast/224436',
                },
                { 
                    id: 'weather-d3', lat: 35.21, lon: 135.90, date: '2026-02-10', 
                    accuUrl: 'https://www.accuweather.com/zh/jp/otsu-shi/220939/daily-weather-forecast/220939',
                },
                { 
                    id: 'weather-d4', lat: 34.68, lon: 135.80, date: '2026-02-11', 
                    accuUrl: 'https://www.accuweather.com/zh/jp/nijoojiminami/2354547/daily-weather-forecast/2354547',
                },
                { 
                    id: 'weather-d5', lat: 34.655, lon: 135.43, date: '2026-02-12', 
                    accuUrl: 'https://www.accuweather.com/zh/jp/umeda/2351574/daily-weather-forecast/2351574',
                },
                { 
                    id: 'weather-d6', lat: 34.69, lon: 135.19, date: '2026-02-13', 
                    accuUrl: 'https://www.accuweather.com/zh/jp/shimoyamatedori/2346212/daily-weather-forecast/2346212',
                },
                { 
                    id: 'weather-d7', lat: 34.40, lon: 135.29, date: '2026-02-14', 
                    accuUrl: 'https://www.accuweather.com/zh/jp/osaka-shi/225007/daily-weather-forecast/225007',
                }
            ];

            const weatherCodes = {
                0: { text: "晴朗", icon: "fa-sun", css: "sunny" },
                1: { text: "晴時多雲", icon: "fa-cloud-sun", css: "partly-cloudy" }, // 更新樣式對應
                2: { text: "多雲", icon: "fa-cloud", css: "cloudy" },
                3: { text: "陰天", icon: "fa-smog", css: "cloudy" },
                45: { text: "有霧", icon: "fa-smog", css: "cloudy" },
                48: { text: "有霧", icon: "fa-smog", css: "cloudy" },
                51: { text: "毛毛雨", icon: "fa-cloud-rain", css: "rain" },
                53: { text: "毛毛雨", icon: "fa-cloud-rain", css: "rain" },
                55: { text: "毛毛雨", icon: "fa-cloud-rain", css: "rain" },
                61: { text: "下雨", icon: "fa-umbrella", css: "rain" },
                63: { text: "下雨", icon: "fa-umbrella", css: "rain" },
                65: { text: "大雨", icon: "fa-umbrella", css: "rain" },
                71: { text: "下雪", icon: "fa-snowflake", css: "snow" },
                73: { text: "下雪", icon: "fa-snowflake", css: "snow" },
                75: { text: "大雪", icon: "fa-snowflake", css: "snow" },
            };

            const today = new Date();
            today.setHours(0,0,0,0);

            for (let loc of locations) {
                const linkEl = document.getElementById(loc.id);
                if (!linkEl) continue;

                // 設定 AccuWeather 連結參數 (計算天數)
                const targetDate = new Date(loc.date);
                targetDate.setHours(0,0,0,0);
                const diffTime = targetDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                let dayParam = diffDays + 1;
                if (dayParam < 1) dayParam = 1; 
                linkEl.href = `${loc.accuUrl}?day=${dayParam}`;

                // ★ 使用手動鎖定數據 ★
                // 這樣可以確保顯示的資訊 100% 符合您的預期
                if (MANUAL_FORECAST[loc.id]) {
                    const data = MANUAL_FORECAST[loc.id];
                    updateCard(linkEl, data.code, data.temp, data.rain, weatherCodes, data.realFeel);
                } else {
                    // Fallback (如果忘記設定手動數據)
                    showNoDataState(linkEl);
                }
            }
        }

        // 輔助函式：更新卡片 UI (新增 realFeel 參數)
        function updateCard(linkEl, code, temp, rain, codesMap, realFeel) {
            // 預設 fallback
            const info = codesMap[code] || { text: "多雲", icon: "fa-cloud", css: "cloudy" };
            
            // 移除舊的 class 並加入新的
            linkEl.className = `weather-card ${info.css}`;

            // 顯示溫度
            const tempBox = linkEl.querySelector('.weather-temp-box');
            tempBox.style.display = 'block';
            tempBox.innerText = `${Math.round(temp)}°`;

            // 顯示圖示
            const iconBox = linkEl.querySelector('.weather-icon-box');
            iconBox.innerHTML = '<i class="fas weather-icon"></i>'; 
            const iconEl = iconBox.querySelector('.weather-icon');
            iconEl.className = `fas ${info.icon} weather-icon`;

            // 計算體感溫度 (如果有手動設定則使用，否則使用原氣溫)
            const feelsLike = (realFeel !== undefined) ? realFeel : temp;

            // 顯示降雨機率與體感 (更新順序：體感在前，降雨在後)
            const metricsBox = linkEl.querySelector('.weather-metrics-box');
            metricsBox.style.marginRight = '12px';
            metricsBox.style.flexDirection = 'row';
            metricsBox.style.alignItems = 'center';
            metricsBox.innerHTML = `
                <div class="metric-item"><i class="fas fa-temperature-high"></i> <span class="val-feels">${Math.round(feelsLike)}°</span></div>
                <div class="metric-item"><i class="fas fa-umbrella"></i> <span class="val-rain">${rain}%</span></div>
            `;
        }

        function showNoDataState(linkEl) {
            linkEl.className = 'weather-card cloudy'; 
            const iconBox = linkEl.querySelector('.weather-icon-box');
            iconBox.innerHTML = '<i class="fas fa-calendar-alt"></i>';
            const tempBox = linkEl.querySelector('.weather-temp-box');
            tempBox.style.display = 'none'; 
            const metricsBox = linkEl.querySelector('.weather-metrics-box');
            metricsBox.style.marginRight = 'auto'; 
            metricsBox.style.flexDirection = 'column';
            metricsBox.style.alignItems = 'flex-start';
            metricsBox.innerHTML = '<div style="font-size:0.9rem; font-weight:700;">點擊查看天氣</div><div style="font-size:0.75rem; opacity:0.9;">AccuWeather 預報</div>';
        }

        /* --- Carousel Logic --- */
        function initCarousel() {
            const carousels = document.querySelectorAll('.carousel-container');
            
            carousels.forEach(carousel => {
                const track = carousel.querySelector('.carousel-track');
                const slides = Array.from(track.children);
                const dots = Array.from(carousel.querySelectorAll('.carousel-dot'));
                const images = carousel.querySelectorAll('img');
                
                let currentIndex = 0;
                let startX = 0;
                let currentTranslate = 0;
                let prevTranslate = 0;
                let isDragging = false;
                let isDraggingChanged = false; // Flag to distinguish drag vs click

                // --- Helper Functions Scoped to this Carousel ---
                function updateCarousel() {
                    track.style.transition = 'transform 0.3s ease-out';
                    const width = carousel.offsetWidth;
                    currentTranslate = -currentIndex * width;
                    prevTranslate = currentTranslate;
                    track.style.transform = `translateX(${currentTranslate}px)`;
                    
                    dots.forEach(d => d.classList.remove('active'));
                    if (dots[currentIndex]) dots[currentIndex].classList.add('active');
                }

                function touchStart(event) {
                    isDragging = true;
                    isDraggingChanged = false;
                    startX = getPositionX(event);
                    track.style.transition = 'none';
                }

                function touchMove(event) {
                    if (!isDragging) return;
                    const currentX = getPositionX(event);
                    const diff = currentX - startX;
                    if (Math.abs(diff) > 5) isDraggingChanged = true;
                    currentTranslate = prevTranslate + diff;
                    track.style.transform = `translateX(${currentTranslate}px)`;
                }

                function touchEnd() {
                    isDragging = false;
                    const movedBy = currentTranslate - prevTranslate;
                    if (movedBy < -50 && currentIndex < slides.length - 1) currentIndex += 1;
                    if (movedBy > 50 && currentIndex > 0) currentIndex -= 1;
                    updateCarousel();
                }

                function getPositionX(event) {
                    return event.type.includes('mouse') ? event.pageX : event.touches[0].clientX;
                }

                // --- Event Listeners ---
                carousel.addEventListener('touchstart', touchStart);
                carousel.addEventListener('touchend', touchEnd);
                carousel.addEventListener('touchmove', touchMove);
                
                carousel.addEventListener('mousedown', touchStart);
                carousel.addEventListener('mouseup', touchEnd);
                carousel.addEventListener('mouseleave', () => { if(isDragging) touchEnd() });
                carousel.addEventListener('mousemove', touchMove);

                // Dot Click
                dots.forEach((dot, index) => {
                    dot.addEventListener('click', (e) => {
                        e.stopPropagation();
                        currentIndex = index;
                        updateCarousel();
                    });
                });

                // Lightbox Trigger (Modified for Carousel)
                // Use slides array to find index relative to the track
                images.forEach((img) => {
                    img.addEventListener('click', (e) => {
                        if (!isDraggingChanged) {
                            // Collect all image sources from this specific carousel track
                            const allImagesInGroup = Array.from(images).map(i => i.src);
                            // Find the index of the clicked image in this group
                            // Note: We use the index relative to the carousel logic
                            openLightbox(allImagesInGroup, currentIndex); 
                        }
                    });
                });

                // Init resize handler for this specific carousel
                window.addEventListener('resize', updateCarousel);
            });

            // Also handle standalone spot images (single image lightboxes)
            const spotImages = document.querySelectorAll('.spot-image:not(.carousel-slide img)');
            spotImages.forEach(img => {
                img.addEventListener('click', (e) => {
                    openLightbox([e.target.src], 0);
                });
            });
        }

        // --- Lightbox Functions (Enhanced) ---
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxDotsContainer = document.getElementById('lightbox-dots');

        // State for Lightbox
        let lbImages = [];
        let lbIndex = 0;
        let lbStartX = 0;
        let lbIsDragging = false;

        function openLightbox(imagesArray, startIndex) {
            lbImages = imagesArray;
            lbIndex = startIndex;
            
            updateLightboxUI();
            lightbox.classList.add('active');
        }

        function closeLightbox() {
            lightbox.classList.remove('active');
        }

        function updateLightboxUI() {
            // Update Image
            lightboxImg.style.opacity = '0.5'; // Simple fade effect
            setTimeout(() => {
                lightboxImg.src = lbImages[lbIndex];
                lightboxImg.style.opacity = '1';
            }, 150);

            // Update Dots
            lightboxDotsContainer.innerHTML = '';
            if (lbImages.length > 1) {
                lbImages.forEach((_, i) => {
                    const dot = document.createElement('div');
                    dot.classList.add('lightbox-dot');
                    if (i === lbIndex) dot.classList.add('active');
                    lightboxDotsContainer.appendChild(dot);
                });
            }
        }

        // Lightbox Swipe Logic
        lightbox.addEventListener('touchstart', (e) => {
            lbStartX = e.touches[0].clientX;
            lbIsDragging = true;
        });

        lightbox.addEventListener('touchmove', (e) => {
            if (!lbIsDragging) return;
            // Prevent default to stop scrolling background (if needed)
            // e.preventDefault(); 
        });

        lightbox.addEventListener('touchend', (e) => {
            if (!lbIsDragging) return;
            const endX = e.changedTouches[0].clientX;
            const diff = endX - lbStartX;
            
            // Threshold for swipe
            if (Math.abs(diff) > 50) {
                if (diff > 0) {
                    // Swipe Right (Prev)
                    if (lbIndex > 0) {
                        lbIndex--;
                        updateLightboxUI();
                    }
                } else {
                    // Swipe Left (Next)
                    if (lbIndex < lbImages.length - 1) {
                        lbIndex++;
                        updateLightboxUI();
                    }
                }
            }
            lbIsDragging = false;
        });

        // Init all
        fetchRate();
        fetchWeather();
        initCarousel();
        // Init map for the initially active day (Day 1)
        setTimeout(() => initDayMap('d1'), 500);

    </script>
</body>
</html>
